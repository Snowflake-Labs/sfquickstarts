name: Publish to AEM on PR Approval (Prod)

on:
  push:
    branches: [master]

jobs:
  publish:
    runs-on: ubuntu-latest
    environment:
      name: production
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Determine changed quickstart folders
        id: detect
        run: |
          # Get changed files from the push
          # For push events, compare the before and after commits
          before_commit="${{ github.event.before }}"
          after_commit="${{ github.sha }}"
          
          # Handle first push to branch (no before commit)
          if [ "$before_commit" = "0000000000000000000000000000000000000000" ]; then
            # First push - check HEAD against previous commit
            changed_files=$(git diff --name-only HEAD^ HEAD || git ls-tree --name-only -r HEAD)
          else
            changed_files=$(git diff --name-only "$before_commit" "$after_commit")
          fi
          
          # Filter to quickstart folders under site/sfguides/src whose names do not start with an underscore
          quickstart_names=$(echo "$changed_files" | grep '^site/sfguides/src/' | sed -E 's|^site/sfguides/src/([^/]+)/.*|\1|' | grep -v '^_' | sort -u)
          
          has_relevant_changes=false
          if [ -z "$quickstart_names" ]; then
            quickstart_names_json="[]"
            quickstart_folders_json="[]"
            quickstart_name=""
            has_relevant_changes=false
          else
            objs='[]'
            names_arr='[]'
            while IFS= read -r name; do
              [ -z "$name" ] && continue
              lang=""
              md_file=""
              candidate="site/sfguides/src/$name/$name.md"
              if [ -f "$candidate" ]; then
                md_file="$candidate"
              else
                for f in $(ls -1 "site/sfguides/src/$name"/*.md 2>/dev/null | sort); do
                  if sed -n '1,50p' "$f" | grep -qi -E '^[[:space:]]*language[[:space:]]*:'; then
                    md_file="$f"; break
                  fi
                done
                if [ -z "$md_file" ]; then
                  for f in $(ls -1 "site/sfguides/src/$name"/*.md 2>/dev/null | sort); do
                    [ "$(basename "$f")" = "README.md" ] && continue
                    md_file="$f"; break
                  done
                fi
                if [ -z "$md_file" ]; then
                  md_file=$(ls -1 "site/sfguides/src/$name"/*.md 2>/dev/null | head -n1 || true)
                fi
              fi
              if [ -n "$md_file" ] && [ -f "$md_file" ]; then
                lang=$(sed -n '1,50p' "$md_file" | grep -m1 -E '^[[:space:]]*language:[[:space:]]*' | sed -E 's/^[[:space:]]*language:[[:space:]]*//')
                lang=$(printf '%s' "$lang" | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')
                if [[ "$lang" =~ ^\".*\"$ ]]; then lang=${lang:1:${#lang}-2}; fi
                if [[ "$lang" =~ ^\'.*\'$ ]]; then lang=${lang:1:${#lang}-2}; fi
              fi
              objs=$(echo "$objs" | jq -c --arg name "$name" --arg lang "$lang" '. + [{name:$name, language:$lang}]')
              names_arr=$(echo "$names_arr" | jq -c --arg name "$name" '. + [$name]')
            done <<< "$quickstart_names"
            quickstart_names_json="$objs"
            quickstart_folders_json=$(echo "$names_arr" | jq -c .)
            quickstart_name=$(printf '%s\n' "$quickstart_names" | head -n1)
            has_relevant_changes=true
          fi
          echo "quickstart_names_json=$quickstart_names_json" >> $GITHUB_OUTPUT
          echo "quickstart_folders_json=$quickstart_folders_json" >> $GITHUB_OUTPUT
          echo "quickstart_name=$quickstart_name" >> $GITHUB_OUTPUT
          echo "has_relevant_changes=$has_relevant_changes" >> $GITHUB_OUTPUT

      - name: Get PR number from commit
        id: pr
        run: |
          pr_number=$(gh pr list --search "${{ github.sha }}" --state merged --json number --jq '.[0].number // ""')
          echo "number=$pr_number" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Call Workato production webhook
        if: steps.detect.outputs.has_relevant_changes == 'true'
        env:
          WORKATO_PROD_WEBHOOK_URL: ${{ secrets.WORKATO_PROD_WEBHOOK_URL }}
        run: |
          if [ -z "$WORKATO_PROD_WEBHOOK_URL" ]; then
            echo "WORKATO_PROD_URL is not set. Cannot call production webhook." >&2
            exit 1
          fi
          payload=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg sha "$GITHUB_SHA" \
            --arg ref "$GITHUB_REF" \
            --arg env "prod" \
            --arg pr_num "${{ steps.pr.outputs.number }}" \
            --arg qname "${{ steps.detect.outputs.quickstart_name }}" \
            --argjson qnames '${{ steps.detect.outputs.quickstart_names_json }}' \
            --argjson qfolders '${{ steps.detect.outputs.quickstart_folders_json }}' \
            '{repo:$repo, commit_sha:$sha, ref:$ref, environment:$env, pr_number:$pr_num, quickstart_name:$qname, quickstart_names:$qnames, quickstart_folders:$qfolders}')
          echo "$payload" | jq .
          response=$(curl -sS -X POST "$WORKATO_PROD_WEBHOOK_URL" -H "Content-Type: application/json" --data-raw "$payload")
          echo "$response" | cat