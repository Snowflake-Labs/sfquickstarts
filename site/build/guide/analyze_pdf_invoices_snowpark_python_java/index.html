
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Analyze PDF Invoices using Snowpark for Java and Python</title>

  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5Q8R2G');</script>
  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-08H27EW14N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-08H27EW14N');
</script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Q8R2G"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <google-codelab-analytics gaid="UA-41491190-9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="analyze_pdf_invoices_snowpark_python_java"
                  title="Analyze PDF Invoices using Snowpark for Java and Python"
                  environment="web"
                  feedback-link="https://github.com/Snowflake-Labs/sfguides/issues">
    
      <google-codelab-step label="Overview" duration="1">
        <p>This Quickstart is designed to help you understand the capabilities included in Snowflake&#39;s support for unstructured data and Snowpark. Although this guide is specific to processing PDF files, you can apply this pattern of processing natively in Snowflake to many types of unstructured data. All source code for this guide can be found on <a href="https://github.com/Snowflake-Labs/sfquickstarts" target="_blank">Github</a>.</p>
<h2 is-upgraded>Prerequisites</h2>
<ul>
<li>Completion of <a href="http://quickstarts.snowflake.com/guide/getting_started_with_unstructured_data/index.html?index=..%2F..index" target="_blank">Getting Started with Unstructured Data</a></li>
</ul>
<h2 is-upgraded>What You&#39;ll Need</h2>
<ul>
<li>Snowflake account</li>
<li><a href="https://docs.snowflake.com/en/user-guide/snowsql.html" target="_blank">SnowSQL</a> installed</li>
</ul>
<h2 class="checklist" is-upgraded>What You&#39;ll Learn</h2>
<ul class="checklist">
<li>How to access PDF invoices in cloud storage from Snowflake</li>
<li>How to extract text from PDFs natively using a Python User-Defined Function (UDF)</li>
<li>How to extract text from PDFs natively using a Java UDF</li>
</ul>
<h2 is-upgraded>What You&#39;ll Build</h2>
<ul>
<li>An external stage to access files in S3 from Snowflake</li>
<li>A user-defined function using Snowflake&#39;s engine to process files</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Prepare Your Environment" duration="2">
        <p>If you haven&#39;t already, register for a <a href="https://trial.snowflake.com/" target="_blank">Snowflake free 30-day trial</a>. The Snowflake edition (Standard, Enterprise, Business Critical, e.g.), cloud provider (AWS, Azure, e.g.), and Region (US East, EU, e.g.) do not matter for this lab. We suggest you select the region which is physically closest to you and the Enterprise Edition, our most popular offering. After registering, you will receive an email with an activation link and your Snowflake account URL.</p>
<h2 is-upgraded>Navigating to Snowsight</h2>
<p>For this lab, you will use the latest Snowflake web interface, Snowsight.</p>
<ol type="1">
<li>Log into your Snowflake trial account</li>
<li>Click on <strong>Snowsight</strong> Worksheets tab. The new web interface opens in a separate tab or window.</li>
<li>Click <strong>Worksheets</strong> in the left-hand navigation bar. The <strong>Ready to Start Using Worksheets and Dashboards</strong> dialog opens.</li>
<li>Click the <strong>Enable Worksheets and Dashboards button</strong>.</li>
</ol>
<p class="image-container"><img alt="Enable worksheets and dashboards" src="img/111785ef48da683b.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Access the Data" duration="6">
        <p>Let&#39;s start by loading the PDF invoices into Snowflake. Snowflake supports two types of stages for storing data files used for loading and unloading:</p>
<ul>
<li><a href="https://docs.snowflake.com/en/user-guide/data-load-overview.html#internal-stages" target="_blank">Internal</a> stages store the files internally within Snowflake.</li>
<li><a href="https://docs.snowflake.com/en/user-guide/data-load-overview.html#external-stages" target="_blank">External</a> stages store the files in an external location (i.e. S3 bucket) that is referenced by the stage. An external stage specifies location and credential information, if required, for the bucket.</li>
</ul>
<p>For this quickstart, we will use an external stage, but processing and analysis workflows demonstrated in this quickstart can also be done using an internal stage.</p>
<h2 is-upgraded>Create a Database, Warehouse, and Stage</h2>
<p>Let&#39;s create a database, warehouse, and stage that will be used for loading and processing the PDFs. We will use the UI within the Worksheets tab to run the DDL that creates the database and schema. Copy the commands below into your trial environment, and execute each individually.</p>
<pre><code language="language-sql" class="language-sql">use role sysadmin;

create or replace database pdf;
create or replace warehouse quickstart;

use database pdf;
use schema public;
use warehouse quickstart;

create or replace stage pdf_external
url=&#34;s3://sfquickstarts/Analyze PDF Invoices/Invoices/&#34;
directory = (enable = TRUE);
</code></pre>
<p>Verify if the PDF files are accessible in your external stage by entering the following command on your Snowflake worksheet.</p>
<pre><code language="language-sql" class="language-sql">ls @pdf_external;
</code></pre>
<p>You should now see an identical list of files from the S3 bucket. Make sure you see 300 files.</p>
<p class="image-container"><img alt="List external stage" src="img/f7f3e2eaafd8e508.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Extract Text from PDFs" duration="10">
        <p>In this section, we want to extract attributes from the PDF invoices. The entities extracted are going to be fields like product names, unit cost, total cost, as well as business name. The goal is to have these fields to enrich the file-level metadata for analytics. We could complete this task with Snowpark for Python or Java.</p>
<h2 is-upgraded>Creating a Python UDF</h2>
<p>The Python code to parse PDFs requires the <a href="https://pypi.org/project/PyPDF2/" target="_blank">PyPDF2</a> library, which is available out of the box inside Snowflake via the <a href="https://repo.anaconda.com/pkgs/snowflake/" target="_blank">Anaconda Snowflake channel</a>.</p>
<pre><code language="language-sql" class="language-sql">-- Create a java function to parse PDF files
create or replace function python_read_pdf(file string)
    returns string
    language python
    runtime_version = 3.8
    packages = (&#39;snowflake-snowpark-python&#39;,&#39;pypdf2&#39;)
    handler = &#39;read_file&#39;
as
$$
from PyPDF2 import PdfFileReader
from snowflake.snowpark.files import SnowflakeFile
from io import BytesIO
def read_file(file_path):
    whole_text = &#34;&#34;
    with SnowflakeFile.open(file_path, &#39;rb&#39;) as file:
        f = BytesIO(file.readall())
        pdf_reader = PdfFileReader(f)
        whole_text = &#34;&#34;
        for page in pdf_reader.pages:
            whole_text += page.extract_text()
    return whole_text
$$;

select python_read_pdf(build_scoped_file_url(@pdf_external,&#39;invoice1.pdf&#39;)) 
as pdf_text;
</code></pre>
<h2 is-upgraded>Creating a Java UDF</h2>
<p>The Java code to parse PDFs requires some dependencies. Instead of downloading those jar files and uploading to an internal stage, you can create an external stage and reference them when creating a UDF inline.</p>
<pre><code language="language-sql" class="language-sql">-- Create external stage to import PDFBox from S3
create or replace stage jars_stage
 url = &#34;s3://sfquickstarts/Common JARs/&#34;
 directory = (enable = true auto_refresh = false);

-- Create a java function to parse PDF files
create or replace function java_read_pdf(file string)
returns String
language java
imports = (&#39;@jars_stage/pdfbox-app-2.0.24.jar&#39;)
HANDLER = &#39;PdfParser.ReadFile&#39;
as
$$
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.text.PDFTextStripper;
import org.apache.pdfbox.text.PDFTextStripperByArea;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;

import com.snowflake.snowpark_java.types.SnowflakeFile;

public class PdfParser {

    public static String ReadFile(String file_url) throws IOException {
SnowflakeFile file = SnowflakeFile.newInstance(file_url);
        try (PDDocument document = PDDocument.load(file.getInputStream())) {

            document.getClass();

            if (!document.isEncrypted()) {

                PDFTextStripperByArea stripper = new PDFTextStripperByArea();
                stripper.setSortByPosition(true);

                PDFTextStripper tStripper = new PDFTextStripper();

                String pdfFileInText = tStripper.getText(document);
                return pdfFileInText;
            }
        }

        return null;
    }
}
$$;
</code></pre>
<h2 is-upgraded>Invoking the UDF</h2>
<p>Either UDF can be invoked on any PDF file with a simple SQL statement. For the purpose of this quickstart, we&#39;ll use the Java UDF. First, make sure to refresh the directory table metadata for your external stage.</p>
<pre><code>alter stage pdf_external refresh;

select java_read_pdf(build_scoped_file_url(@pdf_external,&#39;invoice1.pdf&#39;)) 
as pdf_text;
</code></pre>
<p class="image-container"><img alt="UDF results" src="img/4e4f44f67647ed99.png"></p>
<p>The output is text values extracted from <code>invoice1.pdf</code>.</p>
<pre><code language="language-text" class="language-text">INVOICE
# 1
Abbott Group
Bill To:
Aug 5, 2021
$458.10
Date:
Balance Due:
Item Quantity Rate Amount
Flour - Corn, Fine 18 $11.39 $205.02
Hold Up Tool Storage Rack 14 $9.54 $133.56
Scallop - St. Jaques 9 $13.28 $119.52
$458.10Total:
</code></pre>
<p>UDFs are account-level objects. So if a developer familiar with Java or Python creates a UDF, an analyst in the same account with proper permissions can invoke the UDF in their queries.</p>
<h2 is-upgraded>Extracting and Storing Fields</h2>
<p>We want to store the extracted text as additional attributes for analysts to be able to select and retrieve the files of interest in their analysis, as well as perform some analytics on the attributes found.</p>
<p>We first need to create a table with the extracted text in its raw form. From this table, we can create views to parse the text into various fields for easier analysis. You could use either the Python or Java UDF in the creation of this table, and the code below uses the Java UDF.</p>
<pre><code language="language-sql" class="language-sql">create or replace table java_parsed_pdf as
select
    relative_path
    , file_url
    , java_read_pdf(build_scoped_file_url(@pdf_external, relative_path)) as parsed_text
from directory(@pdf_external);
</code></pre>
<p>Using Snowflake&#39;s string functions, we can parse out specific values as fields like balance due, item name, item quantity, and more.</p>
<pre><code language="language-sql" class="language-sql">create or replace view v__parsed_pdf_fields as (
with items_to_array as (
    select
        *
        , split(
            substr(
              regexp_substr(parsed_text, &#39;Amount\n(.*)\n(.*)\n(.*)&#39;
              ), 8
            ), &#39;\n&#39;
          )
        as items
    from java_parsed_pdf
)
, parsed_pdf_fields as (
    select
        substr(regexp_substr(parsed_text, &#39;# [0-9]+&#39;), 2)::int as invoice_number
        , to_number(substr(regexp_substr(parsed_text, &#39;\\$[^A-Z]+&#39;), 2), 10, 2) as balance_due
        , substr(
            regexp_substr(parsed_text, &#39;[0-9]+\n[^\n]+&#39;)
                , len(regexp_substr(parsed_text, &#39;# [0-9]+&#39;))
            ) as invoice_from
        , to_date(substr(regexp_substr(parsed_text, &#39;To:\n[^\n]+&#39;), 5), &#39;mon dd, yyyy&#39;) as invoice_date
        , i.value::string as line_item
        , parsed_text
    from
        items_to_array
        , lateral flatten(items_to_array.items) i
)
select
    invoice_number
    , balance_due
    , invoice_from
    , invoice_date
    , rtrim(regexp_substr(line_item, &#39; ([0-9]+) \\$&#39;)::string, &#39; $&#39;)::integer as item_quantity
    , to_number(ltrim(regexp_substr(line_item, &#39;\\$[^ ]+&#39;)::string, &#39;$&#39;), 10, 2) as item_unit_cost
    , regexp_replace(line_item, &#39; ([0-9]+) \\$.*&#39;, &#39;&#39;)::string as item_name
    , to_number(ltrim(regexp_substr(line_item, &#39;\\$[^ ]+&#39;, 1, 2)::string, &#39;$&#39;), 10, 2) as item_total_cost
from parsed_pdf_fields
);
</code></pre>
<p>Alternatively to Java, you can create the table using the Python UDF.</p>
<pre><code>create or replace table python_parsed_pdf as
select
    relative_path
    , file_url
    , python_read_pdf(build_scoped_file_url(@pdf_external, relative_path)) as parsed_text
from directory(@pdf_external);
</code></pre>
<p>And if you use the Python UDF to create the table, you can create the view like so.</p>
<pre><code>create or replace view v__parsed_pdf_fields as (
with items_to_array as (
    select
            parsed_text
            , regexp_substr_all(
                substr(
                    regexp_substr(parsed_text, &#39;Amount\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)\n(.*)&#39;
                    ), 8
                ), &#39;[^\n]+\n[^\n]+\n[^\n]+\n[^\n]+&#39;
            )
        as items
    from python_parsed_pdf
)
, parsed_pdf_fields as (
    select
        substr(regexp_substr(parsed_text, &#39;# [0-9]+&#39;), 2)::int as invoice_number
        , to_number(substr(regexp_substr(parsed_text, &#39;\\$[^A-Z]+&#39;), 2), 10, 2) as balance_due
        , substr(
            regexp_substr(parsed_text, &#39;[0-9]+\n[^\n]+&#39;)
                , len(regexp_substr(parsed_text, &#39;# [0-9]+&#39;))
            ) as invoice_from
        , to_date(regexp_substr(parsed_text, &#39;([A-Za-z]+ [0-9]+, [0-9]+)&#39;), &#39;mon dd, yyyy&#39;) as invoice_date
        , i.value::string as line_item
        , parsed_text
    from
        items_to_array
        , lateral flatten(items_to_array.items) i
)
select
    invoice_number
    , balance_due
    , invoice_from
    , invoice_date
    , regexp_substr(line_item, &#39;\n[0-9]+\n&#39;)::integer as item_quantity
    , to_number(ltrim(regexp_substr(line_item, &#39;\\$[^\n]+&#39;)::string, &#39;$&#39;), 10, 2) as item_unit_cost
    , regexp_substr(line_item, &#39;[^\n]+&#39;, 1, 1)::string as item_name
    , to_number(ltrim(regexp_substr(line_item, &#39;\\$[^\n]+&#39;, 1, 2)::string, &#39;$&#39;), 10, 2) as item_total_cost
from parsed_pdf_fields
);
</code></pre>
<p>If you collapse and expand the <code>PDF</code> database in the Objects pane on the left, you should now see a view name <code>V__PARSED_PDF_FIELDS</code>. Click on that view, and below you should see a preview of the fields you have created along with icons to indicate the data type. You can also see a preview of the view by clicking on the button that looks like a magnifier glass.</p>
<p class="image-container"><img alt="Create and preview view" src="img/feccd6f641f8ab65.gif"></p>
<h2 is-upgraded>Exploring Invoice Data</h2>
<p>Now let&#39;s explore the data from the PDF invoices. What are the most purchased items based on quantity?</p>
<pre><code language="language-sql" class="language-sql">select
    sum(item_quantity)
    , item_name
from v__parsed_pdf_fields
group by item_name
order by sum(item_quantity) desc
limit 10;
</code></pre>
<p class="image-container"><img alt="Quantity by Product" src="img/5233492c0fffa430.png"></p>
<p>What are the items on which the most money was spent?</p>
<pre><code language="language-sql" class="language-sql">select
    sum(item_total_cost)
    , item_name
from v__parsed_pdf_fields
group by item_name
order by sum(item_total_cost) desc
limit 10;
</code></pre>
<p class="image-container"><img alt="Cost by Product" src="img/8df6f0fd82addf51.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Analyze the Data with Snowsight" duration="8">
        <p>Now we can use Snowsight to visualize the data extracted from the PDF invoices.</p>
<h2 is-upgraded>Create a Dashboard</h2>
<p>Let&#39;s use a dashboard as a collection of all of the visualizations we will create. Click on the Home button, then click on <strong>Dashboards</strong> in the pane on the left. Create a new dashboard by clicking the <strong>+ Dashboard</strong> button in the top-right. Name the dashboard <code>Invoice Analysis</code>, and click <strong>Create Dashboard</strong>.</p>
<p class="image-container"><img alt="Create Dashboard" src="img/2fe92fbf63e8ad07.png"></p>
<p>Now let&#39;s create the first tile on the Invoice Analysis dashboard by clicking the button <strong>+ New Tile</strong>. Give the tile a name by clicking on the timestamp at the top, and name it <code>Costs by Item</code>. In the canvas, copy/paste the SQL below to query the data needed for the chart and run it.</p>
<pre><code language="language-sql" class="language-sql">select
    sum(item_total_cost)
    , item_name
from v__parsed_pdf_fields
group by item_name
order by sum(item_total_cost) desc;
</code></pre>
<p>Now click on <strong>Chart</strong>. Change the chart type from line to bar, X-Axis to <code>ITEM_NAME</code>, and orientation to horizontal. In this chart, you should see &#34;Lettuce - California Mix&#34; as the item on which the most money was spent, $3,214.68.</p>
<p class="image-container"><img alt="Create Bar Chart" src="img/b1224f1763b677f.png"></p>
<p>Now let&#39;s create another tile by clicking <strong>Return to Invoice Analysis</strong> in the top-left, then click on the <strong>+</strong> button, then <strong>New Tile from Worksheet</strong>. Name the tile <code>Costs by Month</code>. Now copy/paste and run this query.</p>
<pre><code language="language-sql" class="language-sql">select
    sum(item_total_cost)
    , date_trunc(&#39;month&#39;, invoice_date) as month
from v__parsed_pdf_fields
group by date_trunc(&#39;month&#39;, invoice_date);
</code></pre>
<p>Again, click <strong>Chart</strong>. You should see a line chart with <code>MONTH</code> on the x-axis and <code>SUM(ITEM_TOTAL_COST)</code> on the y-axis. Then click <strong>Return to Invoice Analysis</strong>. You should now see two tiles on your dashboard, which you can rearrange by clicking and dragging.</p>
<p class="image-container"><img alt="Create Line Chart" src="img/d940eacd2a92d120.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Conclusion" duration="1">
        <p>Congratulations! You used Snowflake to analyze PDF invoices.</p>
<h2 class="checklist" is-upgraded>What we&#39;ve covered</h2>
<ul class="checklist">
<li>Accessing unstructured data with an <strong>external stage</strong></li>
<li>Processing unstructured data with <strong>Python and Java UDFs</strong></li>
<li>Visualize data with <strong>Snowsight</strong></li>
</ul>
<h2 is-upgraded>Related Resources</h2>
<ul>
<li><a href="https://quickstarts.snowflake.com/guide/extract_attributes_dicom_files_java_udf/index.html" target="_blank">Quickstart: Extract Attributes from DICOM Files using a Java UDF</a></li>
<li><a href="https://docs.snowflake.com/en/user-guide/unstructured.html" target="_blank">Unstructured Data Docs</a></li>
<li><a href="https://docs.snowflake.com/en/developer-guide/snowpark/index.html" target="_blank">Snowpark Docs</a></li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/native-shim.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/custom-elements.min.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/prettify.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>
  <script type="text/javascript">
    window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
    heap.load("2025084205");
  </script>
</body>
</html>
