
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Analyze Query Performance in Snowflake Notebooks</title>

  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5Q8R2G');</script>
  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-08H27EW14N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-08H27EW14N');
</script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Q8R2G"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <google-codelab-analytics gaid="UA-41491190-9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="automated-query-performance-insights"
                  title="Analyze Query Performance in Snowflake Notebooks"
                  environment="web"
                  feedback-link="https://github.com/Snowflake-Labs/sfguides/issues">
    
      <google-codelab-step label="Overview" duration="5">
        <p>You&#39;ll learn how to leverage Snowflake&#39;s <code>ACCOUNT_USAGE</code> schema to analyze query performance, identify bottlenecks, and optimize your SQL queries. This guide provides practical SQL queries that will help you to understand query execution patterns and warehouse utilization.</p>
<h2 class="checklist" is-upgraded>What You&#39;ll Learn</h2>
<ul class="checklist">
<li>How to identify long-running queries</li>
<li>Methods to analyze query execution patterns</li>
<li>Techniques to track warehouse performance</li>
<li>Ways to monitor task execution times</li>
</ul>
<h2 is-upgraded>What You&#39;ll Build</h2>
<p>A collection of analytical SQL queries that provide insights into query performance, warehouse utilization, and task execution patterns.</p>
<h2 is-upgraded>What You&#39;ll Need</h2>
<ul>
<li>Access to a <a href="https://signup.snowflake.com/" target="_blank">Snowflake account</a></li>
<li>Basic SQL knowledge</li>
<li>Access to Snowflake&#39;s <code>ACCOUNT_USAGE</code> schema</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Setup" duration="5">
        <p>Firstly, fire up your Snowflake Notebook by clicking on <code>Projects</code> &gt; <code>Notebooks</code> in the left sidebar followed by clicking on <code>+ Notebook</code> in the top-right hand corner.</p>
<p>Secondly, for forthcoming SQL queries mentioned here after, you can enter them into the SQL cell to run the queries.</p>
<p>Firstly, to follow along with this quickstart, you can click on <a href="https://github.com/Snowflake-Labs/snowflake-demo-notebooks/blob/main/Query_Performance_Insights/Automated_Query_Performance_Insights_in_Snowflake_Notebooks.ipynb" target="_blank">Automated_Query_Performance_Insights_in_Snowflake_Notebooks.ipynb</a> to download the Notebook from GitHub.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Analyze Long-Running Queries" duration="5">
        <p>This query identifies the 50 longest-running queries from the past day:</p>
<pre><code language="language-sql" class="language-sql">SELECT query_id,
  ROW_NUMBER() OVER(ORDER BY partitions_scanned DESC) AS query_id_int,
  query_text,
  total_elapsed_time/1000 AS query_execution_time_seconds,
  partitions_scanned,
  partitions_total
FROM snowflake.account_usage.query_history Q
WHERE warehouse_name = &#39;&lt;your_warehouse_name&gt;&#39; 
  AND TO_DATE(Q.start_time) &gt; DATEADD(day,-1,TO_DATE(CURRENT_TIMESTAMP()))
  AND total_elapsed_time &gt; 0
  AND error_code IS NULL
  AND partitions_scanned IS NOT NULL
ORDER BY total_elapsed_time desc
LIMIT 50;
</code></pre>
<aside class="special"><p> IMPORTANT:</p>
<ul>
<li>Replace â€˜&lt;your_warehouse_name&gt;&#39; with your actual warehouse name.</li>
<li>Adjust the DATEADD function to analyze different time periods</li>
</ul>
</aside>
<p>Here, I&#39;ll specify <code>'CHANIN_XS'</code> as this is the warehouse that I typically use and here&#39;s what the returned results would look like:</p>
<p class="image-container"><img alt="image" src="img/338565e174c7add.PNG"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Analyze Query Patterns in Relation to Execution Time" duration="5">
        <p>Group queries by execution time buckets:</p>
<pre><code language="language-sql" class="language-sql">SELECT
  CASE
    WHEN Q.total_elapsed_time &lt;= 1000 THEN &#39;Less than 1 second&#39;
    WHEN Q.total_elapsed_time &lt;= 60000 THEN &#39;1 second to 1 minute&#39;
    WHEN Q.total_elapsed_time &lt;= 300000 THEN &#39;1 minute to 5 minutes&#39;
    ELSE &#39;more than 5 minutes&#39;
  END AS BUCKETS,
  COUNT(query_id) AS number_of_queries
FROM snowflake.account_usage.query_history Q
WHERE TO_DATE(Q.START_TIME) &gt; DATEADD(month,-1,TO_DATE(CURRENT_TIMESTAMP()))
  AND total_elapsed_time &gt; 0
  AND warehouse_name = &#39;&lt;your_warehouse_name&gt;&#39;
GROUP BY 1;
</code></pre>
<p>An analysis of the query patterns for my warehouse <code>'CHANIN_XS'</code> returned the following output:</p>
<p class="image-container"><img alt="image" src="img/550171bd57994a71.PNG"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Analyze Query Patterns to Find Repeated Queries" duration="5">
        <p>Identify frequently executed queries:</p>
<pre><code language="language-sql" class="language-sql">SELECT
    query_hash,
    COUNT(*),
    SUM(total_elapsed_time),
    ANY_VALUE(query_id)
FROM snowflake.account_usage.query_history
WHERE warehouse_name = &#39;&lt;your_warehouse_name&gt;&#39;
  AND DATE_TRUNC(&#39;day&#39;, start_time) &gt;= CURRENT_DATE() - 7
GROUP BY query_hash
ORDER BY SUM(total_elapsed_time) DESC
LIMIT 100;
</code></pre>
<p>Here&#39;s the returned output for my frequently executed queries:</p>
<p class="image-container"><img alt="image" src="img/a845aa24a4afea85.PNG"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Analyze Warehouse Load" duration="5">
        <p>Monitor warehouse utilization:</p>
<pre><code language="language-sql" class="language-sql">SELECT TO_DATE(start_time) AS date,
  warehouse_name,
  SUM(avg_running) AS sum_running,
  SUM(avg_queued_load) AS sum_queued
FROM snowflake.account_usage.warehouse_load_history
WHERE TO_DATE(start_time) &gt;= DATEADD(month,-1,CURRENT_TIMESTAMP())
GROUP BY 1,2
HAVING SUM(avg_queued_load) &gt;0;
</code></pre>
<p>Results from warehouse utilization is shown below:</p>
<p class="image-container"><img alt="image" src="img/d02635361941c3f7.PNG"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Identify Long-Running Tasks" duration="5">
        <p>Track task execution times:</p>
<pre><code language="language-sql" class="language-sql">SELECT DATEDIFF(seconds, query_start_time,completed_time) AS duration_seconds,*
FROM snowflake.account_usage.task_history
WHERE state = &#39;SUCCEEDED&#39;
  AND query_start_time &gt;= DATEADD (week, -1, CURRENT_TIMESTAMP())
ORDER BY duration_seconds DESC;
</code></pre>
<p>The returned output for task execution time is shown below:</p>
<p class="image-container"><img alt="image" src="img/565a53e81e1b06f2.PNG"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Conclusion And Resources" duration="5">
        <p>Congratulations! You&#39;ve successfully learned how to analyze and optimize query performance in Snowflake using SQL queries. These analytical tools will help you identify bottlenecks and improve your data operations efficiency.</p>
<h2 is-upgraded>What You Learned</h2>
<ul>
<li>Identify and analyze long-running queries</li>
<li>Methods to track query execution patterns</li>
<li>Monitor warehouse performance</li>
</ul>
<h2 is-upgraded>Related Resources</h2>
<p>Articles:</p>
<ul>
<li><a href="https://docs.snowflake.com/en/user-guide/performance-query-exploring" target="_blank">Exploring Query Execution Times</a></li>
<li><a href="https://docs.snowflake.com/en/sql-reference/account-usage" target="_blank">Account Usage</a></li>
</ul>
<p>Documentation:</p>
<ul>
<li><a href="https://docs.snowflake.com/" target="_blank">Snowflake Documentation</a></li>
</ul>
<p>Happy coding!</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/native-shim.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/custom-elements.min.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/prettify.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>
  <script type="text/javascript">
    window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
    heap.load("2025084205");
  </script>
</body>
</html>
