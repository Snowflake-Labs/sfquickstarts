
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Using Fluentd to Send Log Files to Snowflake for Security and Observability Analytics</title>

  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5Q8R2G');</script>
  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-08H27EW14N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-08H27EW14N');
</script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Q8R2G"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <google-codelab-analytics gaid="UA-41491190-9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="integrating_fluentd_with_snowflake"
                  title="Using Fluentd to Send Log Files to Snowflake for Security and Observability Analytics"
                  environment="web"
                  feedback-link="https://github.com/Snowflake-Labs/sfguides/issues">
    
      <google-codelab-step label="Overview" duration="2">
        <p>This Quickstart shows how to use Fluentd to send system event logs to Snowflake for use as a SIEM or for log analysis. We use Apache HTTP Server to generate access log files, which we upload as gzip files to an S3 external stage. Next, we set up Snowpipe to retrieve the gzip files from the external stage and import them into Snowflake. Finally we use Snowsight to visualize log events.</p>
<aside class="special"><p>Note: There is not currently a plug-in that Fluentd can use to directly connect to the Snowflake internal stage, so Fluentd puts processed data in the Snowflake external stage where Snowpipe auto-ingests it.</p>
</aside>
<h2 is-upgraded>What is Fluentd?</h2>
<p>Fluentd is open-source software that parses event logs, application logs, and clickstreams, converts the semi- or un-structured data to structured data, and stores the structured data in an S3 bucket. To learn more about Fluentd, see: <a href="https://www.fluentd.org/" target="_blank">https://www.fluentd.org/</a></p>
<h2 class="checklist" is-upgraded>What You&#39;ll Learn</h2>
<ul class="checklist">
<li>How to deploy Apache2 on a target server (Amazon Linux)</li>
<li>How to deploy the Fluentd agent (td-agent) on a target server</li>
<li>How to set up an external stage on Snowflake</li>
<li>How to set up Snowpipe to retrieve data from the external stage</li>
</ul>
<h2 is-upgraded>Prerequisites</h2>
<p>Prior to starting you should:</p>
<ul>
<li>Create a Snowflake Account</li>
<li>Configure AWS VPC settings, like subnet / security rules</li>
<li>Deploy the bastion host on the AWS VPC</li>
<li>Deploy the S3 bucket, create an IAM role, and get the access key and secret key</li>
</ul>
<h2 is-upgraded>Fluentd + Snowflake Integration Architecture</h2>
<p class="image-container"><img alt="Logical diagram showing how Fluentd integrates with Snowflake" src="img/fa76d0ed07df1d3a.png"></p>
<aside class="special"><p>Note: In this scenario, the Apache server instances are internet-facing, so anyone can access it</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy Apache2 on the Target Server (Amazon Linux)" duration="10">
        <p>After deploying Amazon Linux from the official AWS AMI, log in to Linux:</p>
<ul>
<li><strong>Username:</strong> ec2-user</li>
<li><strong>Key-pair:</strong> Use the key-pair file that was created for this instance</li>
</ul>
<p>Ensure that the security group configuration only has the necessary ports open.</p>
<p>Install Apache2, start the service, and set up auto-run:</p>
<pre><code language="language-bash" class="language-bash">sudo yum update
sudo yum -y install httpd
sudo systemctl start httpd.service
sudo systemctl enable httpd.service
</code></pre>
<p>Create a test web page:</p>
<pre><code language="language-bash" class="language-bash">sudo sh -c &#39;echo &#34;hello world&#34; &gt; /var/www/html/index.html&#39;
</code></pre>
<p>Open a browser and enter the target server&#39;s IP address in the address bar. You should see a page similar to the following with the text &#34;hello world!!&#34;</p>
<p class="image-container"><img alt="Screen capture shows the text &amp;ldquo;hello world!!&#34;" src="img/9519192c82fb9fbe.png"></p>
<p>Run the following command to verify that the access log shows recent access:</p>
<pre><code language="language-bash" class="language-bash"> sudo cat /var/log/httpd/access_log
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy the Fluentd Agent (td-agent) on the Target Server" duration="15">
        <p>Install Fluentd, start the service, and set up auto-run:</p>
<pre><code language="language-bash" class="language-bash">curl -L https://toolbelt.treasuredata.com/sh/install-amazon2-td-agent4.sh | sh
sudo systemctl start td-agent.service
</code></pre>
<p>Change the permissions for the <code>httpd</code> file and folder to allow Fluentd to retrieve access logs:</p>
<pre><code language="language-bash" class="language-bash">sudo chmod o+rx /var/log/httpd/
sudo chmod o+rx /var/log/httpd/*
</code></pre>
<p>Create a buffer folder to upload data to S3:</p>
<pre><code language="language-bash" class="language-bash">sudo mkdir /var/log/td-agent/s3
sudo chown td-agent:td-agent /var/log/td-agent/s3
</code></pre>
<p>Open the Fluentd configuration file:</p>
<pre><code language="language-bash" class="language-bash">sudo vi /etc/td-agent/td-agent.conf
</code></pre>
<p>Paste the following command into the file and update the S3 bucket information:</p>
<pre><code language="language-xml" class="language-xml">&lt;source&gt;
  @type tail
  path /var/log/httpd/access_log
  pos_file /var/log/td-agent/apache2.access_log.pos
  &lt;parse&gt;
    @type apache2
  &lt;/parse&gt;
  tag s3.apache.access
&lt;/source&gt;
&lt;match s3.*.*&gt;
  @type s3
  aws_key_id [AWS Access Key]
  aws_sec_key [AWS Secret key]
  s3_bucket [S3 Bucket Name, Ex:masaya-s3-northeast-1-external-stage]
  path logs/

  &lt;buffer&gt;
    @type file
    path /var/log/td-agent/s3
    timekey 60  # 1 min
    timekey_wait 1m
    chunk_limit_size 256m
  &lt;/buffer&gt;

  time_slice_format %Y%m%d%H
&lt;/match&gt;
</code></pre>
<p>Reboot Fluentd:</p>
<pre><code language="language-bash" class="language-bash">sudo service td-agent restart
</code></pre>
<p>Confirm that the Apache access logs were uploaded to S3 as gzip files. This may take a few minutes.</p>
<p class="image-container"><img src="img/4f9561815447d1c0.png"></p>
<p>The data should look similar to the following (CSV, tabs are the delimiters): <img src="img/2af607f75edddd13.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Set up the External Stage on Snowflake" duration="15">
        <p>Use an IAM role that can retrieve data from S3 to create a storage integration. To get the <code>STORAGE_AWS_ROLE_ARN</code>, see <a href="https://docs.snowflake.com/en/user-guide/data-load-s3-config.html" target="_blank">Configuring Secure Access to Amazon S3</a> and complete the steps.</p>
<pre><code language="language-bash" class="language-bash">use role accountadmin;
create STORAGE INTEGRATION s3_int_fluentd
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = S3
  ENABLED = TRUE
  STORAGE_AWS_ROLE_ARN = &#39;arn:aws:iam::xx:role/[RoleName]&#39;
  STORAGE_ALLOWED_LOCATIONS = (&#39;s3://masaya-s3-northeast-1-external-stage/logs/&#39;)
;

DESC INTEGRATION s3_int_fluentd;
</code></pre>
<p class="image-container"><img src="img/205bc4b17a517db9.png"></p>
<p>Create the external stage:</p>
<pre><code>create stage fluentd_stage
  url = &#39;s3://[BUCKET_NAME]/logs/&#39;
  storage_integration = s3_int_fluentd
;
</code></pre>
<p>Verify that Snowflake can list S3 files:</p>
<pre><code>list @fluentd_stage;
</code></pre>
<p class="image-container"><img src="img/1078139725509f23.png"></p>
<p>Create the file format (Fluentd&#39;s delimiter is the tab = \t):</p>
<pre><code>create or replace file format fluentd_format
  type = csv
  field_delimiter = &#39;\t&#39;  
  compression=gzip
;
</code></pre>
<p>Create a table:</p>
<pre><code>create table public.logs(
  time DATETIME,
  tag STRING,
  record VARIANT
);
</code></pre>
<p>Test the injection from the external stage:</p>
<pre><code>copy into public.logs
  from @fluentd_stage
  file_format = (format_name = fluentd_format);
</code></pre>
<p>Select the data:</p>
<pre><code>select * from public.logs;
</code></pre>
<p class="image-container"><img src="img/9613d75b8873afb5.png"></p>
<p>The parsed log should be stored as JSON in the &#34;RECORD&#34; column.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Set up Snowpipe to Retrieve Data From the External Stage" duration="15">
        <p>Configure Snowflake Snowpipe:</p>
<pre><code language="language-sql" class="language-sql">create pipe fluentd.public.mypipe auto_ingest=true as
  copy into fluentd.public.logs
  from @fluentd.public.fluentd_stage
  file_format = fluentd.public.fluentd_format
;
</code></pre>
<p>Run <code>show pipes</code> to retrieve the SQS queue ARN:</p>
<pre><code language="language-sql" class="language-sql">show pipes;
</code></pre>
<p class="image-container"><img src="img/bb179ac930fc7796.png"></p>
<p>Set up the S3 bucket by following these steps: <a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/enable-event-notifications.html" target="_blank">Enabling and configuring event notifications using the Amazon S3 console</a>. Choose <strong>Target Bucket</strong> &gt; <strong>Open property</strong>. Select <strong>Create Event notification</strong>.</p>
<p class="image-container"><img src="img/87b7f82d7f20dbb2.png"></p>
<p>Complete the form:</p>
<ul>
<li><strong>Name</strong>: Type a name for the event notification (<em>e.g.</em> Auto-ingest Snowflake)</li>
<li><strong>Prefix</strong> (Optional): Specify a Prefix value to only receive notifications when files are added to a specific folder (for example, logs/)</li>
<li><strong>Event types</strong>: Select the option for <strong>ObjectCreate (All)</strong></li>
<li><strong>Send to</strong>: Select <strong>SQS Queue</strong></li>
<li><strong>SQS</strong>: Select <strong>Add SQS queue ARN</strong></li>
<li><strong>SQS queue ARN</strong>: Paste the SQS queue name from the SHOW PIPES output</li>
</ul>
<p class="image-container"><img src="img/16d8a7b2be0bdcea.png"></p>
<p>The event notification has been created:</p>
<p class="image-container"><img src="img/f0a6535e11947a9e.png"></p>
<p>Refresh Snowpipe to retrieve any unloaded files, then un the <code>select</code> command to load unloaded data:</p>
<pre><code language="language-sql" class="language-sql">alter pipe mypipe refresh;
select * from public.logs;
</code></pre>
<p>After awhile, data may be injected automatically:</p>
<pre><code language="language-sql" class="language-sql">select * from public.logs order by TIME DESC;
</code></pre>
<p class="image-container"><img src="img/278fb79fa5bf2321.png"></p>
<p>To verify that Snowpipe worked properly, run the following:</p>
<pre><code language="language-sql" class="language-sql">use role accountadmin;
select *
  from table(snowflake.information_schema.pipe_usage_history(
    date_range_start=&gt;dateadd(&#39;day&#39;,-14,current_date()),
    date_range_end=&gt;current_date(),
    pipe_name=&gt;&#39;fluentd.public.mypipe&#39;));
</code></pre>
<p class="image-container"><img src="img/4c19e9717a4d708d.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Set up Snowsight to Visualize log Events" duration="12">
        <p>Since parsed logs are stored as JSON in the <code>RECORD</code> column, you can set up Snowsight to visualize log events.</p>
<p><strong>Example 1:</strong> To make a Snowsight dashboard, copy and paste the following code:</p>
<pre><code language="language-sql" class="language-sql">SELECT
    time,
    RECORD:agent,
    RECORD:code,
    RECORD:host,
    RECORD:method,
    RECORD:path,
    RECORD:referer,
    RECORD:size,
    RECORD:user
FROM
    fluentd.public.logs
WHERE time &gt; (select dateadd(day, -1, getdate()));
;
</code></pre>
<p><strong>Example 2:</strong> TIME count = Bar, TIME none = X-Axis</p>
<p>Web Server Access History per Hour <img src="img/78fdd0c8ded1fa9a.png"></p>
<p><strong>Example 3:</strong> TIME count = Bar, RECORD:HOST none = X-Axis Source IP List</p>
<p class="image-container"><img src="img/976212e998ce4d59.png"></p>
<p><strong>Example 4:</strong> TIME count = Bar, RECORD:HOST none = Series, RECORD:CODE none = X-Axis Response Code &amp; Source IP</p>
<p><strong>Example 5:</strong> Code 408 is connection time out = maybe DDOS or CPU shortage.</p>
<p class="image-container"><img src="img/5ef3bbd0c7432b62.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Conclusion and Resources" duration="2">
        <p>Congratulations! You learned how to configure Fluentd to send system event logs to Snowflake, and how to use Snowsight to visualize log events! Consolidating log files in Snowflake makes it possible to develop a single dashboard to monitor security activity across your network.</p>
<h2 is-upgraded>What You Learned</h2>
<ul>
<li>How to deploy td-agent (the Fluentd Agent) on the target server</li>
<li>How to configure Snowpipe to retrieve data from the S3 external stage and import it into Snowflake</li>
<li>How to configure Snowsight to visualize log events</li>
</ul>
<h2 is-upgraded>Related Resources</h2>
<ul>
<li><a href="https://www.fluentd.org/" target="_blank">https://www.fluentd.org/</a></li>
<li><a href="https://docs.snowflake.com/en/user-guide/data-load-s3-config.html" target="_blank">Configuring Secure Access to Amazon S3 (Snowflake Product Documentation)</a></li>
<li><a href="https://docs.snowflake.com/en/user-guide/data-load-snowpipe-auto-s3.html#option-1-creating-a-new-s3-event-notification-to-automate-snowpipe" target="_blank">Creating a New S3 Event Notification to Automate Snowpipe (Snowflake Product Documentation)</a></li>
<li><a href="https://www.cisecurity.org/benchmark/apache_http_server" target="_blank">CIS Apache HTTP Server Benchmarks</a></li>
<li><a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=Apache%20HTTP%20server" target="_blank">CVE Records for Apache HTTP Server</a></li>
<li><a href="https://docs.hunters.ai/wiki/fluentd" target="_blank">https://docs.hunters.ai/wiki/fluentd</a></li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/native-shim.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/custom-elements.min.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/prettify.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>
  <script type="text/javascript">
    window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
    heap.load("2025084205");
  </script>
</body>
</html>
