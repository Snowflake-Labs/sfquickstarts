
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Monitor Table Size Growth in Snowflake Notebooks</title>

  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-5Q8R2G');</script>
  

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-08H27EW14N"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-08H27EW14N');
</script>

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5Q8R2G"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  
  <google-codelab-analytics gaid="UA-41491190-9"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="table-size-growth"
                  title="Monitor Table Size Growth in Snowflake Notebooks"
                  environment="web"
                  feedback-link="https://github.com/Snowflake-Labs/sfguides/issues">
    
      <google-codelab-step label="Overview" duration="5">
        <p>In this quickstarts, you&#39;ll learn how to leverage Snowflake Notebooks with Streamlit integration to track and analyze table storage growth trends.</p>
<p>This article will show you how to identify large tables, analyze query patterns, and monitor user interactions to optimize storage usage and query performance.</p>
<h2 class="checklist" is-upgraded>What You&#39;ll Learn</h2>
<ul class="checklist">
<li>How to identify the top 100 largest tables in your Snowflake account</li>
<li>How to analyze query patterns on specific tables</li>
<li>How to track user interactions with tables</li>
<li>How to use Streamlit widgets for interactive data exploration</li>
</ul>
<h2 is-upgraded>What You&#39;ll Build</h2>
<p>An interactive notebook that helps monitor table storage growth and analyze query patterns using Snowflake&#39;s account usage views and Streamlit widgets.</p>
<h2 is-upgraded>What You&#39;ll Need</h2>
<ul>
<li>Access to a <a href="https://signup.snowflake.com/" target="_blank">Snowflake account</a></li>
<li>Basic knowledge of SQL and Python</li>
<li>Familiarity with Snowflake Notebooks</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Setup" duration="5">
        <p>Firstly, to follow along with this quickstart, you can click on <a href="https://github.com/Snowflake-Labs/snowflake-demo-notebooks/blob/main/Monitoring_Table_Size_with_Streamlit/Monitoring_Table_Size_with_Streamlit.ipynb" target="_blank">Monitoring_Table_Size_with_Streamlit.ipynb</a> to download the Notebook from GitHub.</p>
<p>Snowflake Notebooks comes pre-installed with essential Python libraries for data analysis, including Numpy, Pandas, and Streamlit. No additional package installation is required for this tutorial.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Identify Large Tables" duration="10">
        <h2 is-upgraded>Query Top Tables</h2>
<p>Execute the following SQL to identify the largest tables:</p>
<pre><code language="language-sql" class="language-sql">SELECT 
    CONCAT(TABLE_CATALOG, &#39;.&#39;, TABLE_SCHEMA, &#39;.&#39;, TABLE_NAME) AS FULLY_RESOLVED_TABLE_NAME,
    TABLE_OWNER,
    LAST_DDL,
    LAST_DDL_BY,
    ROW_COUNT,
    ROUND(BYTES / 1024 / 1024 / 1024, 2) AS SIZE_GB,
    LAST_ALTERED,
    CASE 
        WHEN LAST_DDL &lt;= DATEADD(DAY, -90, CURRENT_DATE) THEN &#39;YES&#39; 
        ELSE &#39;NO&#39; 
    END AS LAST_ACCESSED_90DAYS
FROM SNOWFLAKE.ACCOUNT_USAGE.TABLES
WHERE DELETED IS NULL
  AND ROW_COUNT &gt; 0
  AND LAST_ACCESSED_90DAYS = &#39;NO&#39;
ORDER BY ROW_COUNT DESC
LIMIT 100;
</code></pre>
<p>Note: The above SQL cell is named <code>sql_top_tables</code>.</p>
<h2 is-upgraded>Convert to Pandas DataFrame</h2>
<p>Here, we&#39;ll easily convert the SQL output to a Pandas DataFrame like so:</p>
<pre><code language="language-python" class="language-python">sql_top_tables.to_pandas()
</code></pre>
<p>Note: The above Python cell is named <code>sql_top_tables_pd</code>.</p>
<p>The returned output is shown below:</p>
<p class="image-container"><img alt="image" src="img/fc3d1ae106ffcdbf.PNG"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Analyze Query Patterns" duration="10">
        <h2 is-upgraded>Create Interactive Table Selection</h2>
<p>Let&#39;s now create a text box for accepting the table path.</p>
<pre><code language="language-python" class="language-python">import streamlit as st

selection = st.text_input(label=&#34;Enter a fully resolved table path to explore&#34;)
</code></pre>
<p>From the first column of the above table, we&#39;ll copy the path to a table of our choice, which in this example is <code>PENGUINS_ML_APP.DATA.PENGUINS</code>, then paste it to the text box as shown below:</p>
<p class="image-container"><img alt="image" src="img/2e9cc3f88e9a2b5c.PNG"></p>
<h2 is-upgraded>Analyze Query Performance</h2>
<p>Let&#39;s now pass that variable into a SQL query so we can grab query analytics on this table. Note that we&#39;ll name the cell to <code>sql_most_expensive_queries_on_table</code>.</p>
<pre><code language="language-sql" class="language-sql">SELECT 
    &#39;&#123;&#123;selection}}&#39; as FULLY_RESOLVED_TABLE_NAME,
    q.QUERY_TEXT,
    q.QUERY_TYPE,
    SUM(CREDITS_USED_CLOUD_SERVICES) as CREDITS_USED,
    MAX(TOTAL_ELAPSED_TIME) as MAX_elapsed_time,
    AVG(TOTAL_ELAPSED_TIME)/1000 as AVG_EXECUTION_TIME_SEC
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY q
WHERE START_TIME &gt;= CURRENT_DATE - interval &#39;90 days&#39;
    AND query_text LIKE &#39;%&#123;&#123;selection}}%&#39;
GROUP BY ALL
ORDER BY AVG_EXECUTION_TIME_SEC DESC
LIMIT 10
</code></pre>
<p>This returns the following table output:</p>
<p class="image-container"><img alt="image" src="img/9ecae9cdc022b1f0.PNG"></p>
<p>Next, we&#39;ll use the SQL cell name from above and convert it into a Pandas DataFrame using <code>to_pandas()</code>:</p>
<pre><code language="language-python" class="language-python">df = sql_most_expensive_queries_on_table.to_pandas()
st.dataframe(df,
             column_config={
                &#34;CREDITS_USED&#34;: st.column_config.ProgressColumn(
                &#34;CREDITS_USED&#34;,
                format=&#34;%.4f&#34;,
                min_value=df.CREDITS_USED.min(),
                max_value=df.CREDITS_USED.max(),
        ),
    },)
</code></pre>
<p>After converting to a Pandas DataFrame, we&#39;ll stylize this via <code>st.dataframe()</code> (notice the progress bar visuals):</p>
<p class="image-container"><img alt="image" src="img/9cc5d89aeb821adf.PNG"></p>
<p>Make note that the above cell is named <code>py_visualization</code>, which we&#39;ll make reference to in this tutorial.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Track User Interactions" duration="10">
        <h2 is-upgraded>Identify Active Users</h2>
<p>Let&#39;s say we want to take our top most expensive query and turn it into a materialization. Who will be the users who are most likely to be impacted by our activities?</p>
<p>To find out, we&#39;re going to grab the list of users who queried our table of interest in the last 90 days as well as the users who have executed the expensive query. We can then contact them when we make an update and tell them about improvements we made!</p>
<p>First, let&#39;s find out who has used our table in the last 90 days.  We already have a variable <code>selection</code> we can use, so we&#39;re plugging it into the below query:</p>
<pre><code language="language-sql" class="language-sql">SELECT 
    USER_NAME, 
    COUNT(*) number_of_queries
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY q
WHERE START_TIME &gt;= CURRENT_DATE - interval &#39;90 days&#39;
    AND query_text LIKE &#39;%&#123;&#123;selection}}%&#39;
GROUP BY ALL
ORDER BY number_of_queries DESC
</code></pre>
<p>This returns the following results:</p>
<p class="image-container"><img alt="image" src="img/9cc5d89aeb821adf.PNG"></p>
<p>Now, let&#39;s say we want to materialize a specific long running query. Grab a query from the <code>py_visualization</code> cell.</p>
<p>We can now plug it into the <code>QUERY_TEXT</code> value below to find out who else would benefit from materializing this pattern. And this returns the following:</p>
<p class="image-container"><img alt="image" src="img/b60e9f47bdeeb07d.PNG"></p>
<pre><code language="language-python" class="language-python">query_selection = st.text_input(label=&#34;Enter the query text you want to look up&#34;)
st.write(&#34;**You Entered:** `&#34; + query_selection + &#34;`&#34;)
</code></pre>
<p>Sweet! Now we get a list of all the users who might have run this query, along with their total credit consumption and query execution time over the last 90 days.</p>
<pre><code language="language-sql" class="language-sql">SELECT 
    USER_NAME, 
    SUM(CREDITS_USED_CLOUD_SERVICES) as total_credits, 
    MAX(TOTAL_ELAPSED_TIME) as MAX_elapsed_time,
    AVG(TOTAL_ELAPSED_TIME)/1000 as AVG_EXECUTION_TIME_SEC
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY q
WHERE START_TIME &gt;= CURRENT_DATE - interval &#39;90 days&#39;
    AND query_text LIKE &#39;%&#123;&#123;query_selection}}%&#39;
GROUP BY ALL
ORDER BY total_credits DESC
</code></pre>
<p>And the query output is shown below:</p>
<p class="image-container"><img alt="image" src="img/d7c97dc5485735d6.PNG"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Conclusion And Resources" duration="5">
        <p>Congratulations! You&#39;ve successfully built an interactive notebook for monitoring table storage growth and analyzing query patterns in Snowflake. This tool will help you make data-driven decisions about storage optimization and query performance improvements.</p>
<h2 is-upgraded>What You Learned</h2>
<ul>
<li>How to identify and analyze large tables in your Snowflake account</li>
<li>How to track query patterns and performance metrics</li>
<li>How to monitor user interactions with specific tables</li>
<li>How to integrate Streamlit widgets for interactive analysis</li>
</ul>
<h2 is-upgraded>Related Resources</h2>
<p>Documentation:</p>
<ul>
<li><a href="https://docs.snowflake.com/" target="_blank">Snowflake Documentation</a></li>
<li><a href="https://docs.streamlit.io/" target="_blank">Streamlit Documentation</a></li>
</ul>
<p>Articles:</p>
<ul>
<li><a href="https://docs.snowflake.com/en/sql-reference/account-usage" target="_blank">Account Usage Reference</a></li>
<li><a href="https://docs.snowflake.com/en/sql-reference/account-usage/query_history" target="_blank">Query History View</a></li>
<li><a href="https://docs.snowflake.com/en/user-guide/ui-snowsight/notebooks-use-with-snowflake" target="_blank">Snowflake Notebooks Guide</a></li>
</ul>
<p>Happy coding!</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/native-shim.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/custom-elements.min.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/prettify.js"></script>
  <script src="https://quickstarts.snowflake.com/elements/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>
  <script type="text/javascript">
    window.heap=window.heap||[],heap.load=function(e,t){window.heap.appid=e,window.heap.config=t=t||{};var r=t.forceSSL||"https:"===document.location.protocol,a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=(r?"https:":"http:")+"//cdn.heapanalytics.com/js/heap-"+e+".js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n);for(var o=function(e){return function(){heap.push([e].concat(Array.prototype.slice.call(arguments,0)))}},p=["addEventProperties","addUserProperties","clearEventProperties","identify","removeEventProperty","setEventProperties","track","unsetEventProperty"],c=0;c<p.length;c++)heap[p[c]]=o(p[c])};
    heap.load("2025084205");
  </script>
</body>
</html>
