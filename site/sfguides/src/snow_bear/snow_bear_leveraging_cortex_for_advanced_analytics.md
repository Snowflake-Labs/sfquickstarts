```


---

# Snow Bear Fan Experience Analytics Quickstart

author: John Doe
id: snowbear-fan-experience-analytics-quickstart
summary: A quickstart guide for Snow Bear Fan Experience Analytics
categories: Getting-Started
environments: web
status: Published
feedback link: https://github.com/Snowflake-Labs/sfguides/issues
tags: Getting Started, Data Science, Data Engineering

## Snow Bear Fan Experience Analytics

Duration: 1

Snow Bear Fan Experience Analytics is an internal analytics platform that demonstrates advanced Cortex AI capabilities for customer experience analysis. This implementation uses basketball fan survey data to showcase sentiment analysis, automated theme extraction, and intelligent recommendation generation within the Snowflake ecosystem.

The platform serves as a reference implementation for:

- Multi-dimensional customer feedback analysis
- Cortex AI function integration patterns
- Streamlit application development on Snowflake
- DataOps deployment workflows

### Prerequisites

- A [GitHub](https://github.com/) Account
- Access to Snowflake instance

### What You Will Learn

- How to use Cortex AI functions for sentiment analysis, automated theme extraction, and intelligent recommendation generation
- How to develop Streamlit applications on Snowflake
- How to implement DataOps deployment workflows

### What You Will Need

- A [GitHub](https://github.com/) Account
- Access to Snowflake instance

### What You Will Build

- A multi-tab analytics interface with 7 specialized dashboards for different analysis perspectives
- Cortex AI integration with SENTIMENT, EXTRACT_ANSWER, and COMPLETE function implementations
- An automated data processing pipeline with AI-powered theme extraction and segmentation
- Interactive visualizations using Altair-based charts with dynamic filtering and drill-down
- A semantic search feature using Cortex Search Service for natural language queries
- A natural language analytics feature using Cortex Analyst integration for ad-hoc exploration

## Access Instructions

### Open the Analytics Application

**1.)** Open Snowsight:

<button>

  [Open Snowsight](link.com)
</button>

**2.)** Switch to role: `{{ DATAOPS_CATALOG_SOLUTION_PREFIX }}_DATA_SCIENTIST`

**3.)** Navigate to: **Streamlit** > **{{ DATAOPS_CATALOG_SOLUTION_PREFIX }}_SNOWBEAR_FAN_360**

## Application Overview

The analytics platform contains 7 analysis modules:

1. **üìä Executive Dashboard** - High-level metrics, trends, and KPIs for business leaders
2. **üë• Fan Journey Explorer** - Individual fan profiles and experience deep-dives
3. **üí≠ Sentiment Deep Dive** - AI-powered sentiment analysis across all touchpoints
4. **üéØ Theme & Segment Analysis** - Automated theme categorization and fan segmentation
5. **üöÄ Recommendation Engine** - AI-generated business improvement suggestions
6. **üîç Interactive Search** - Cortex Search for natural language queries
7. **üß† AI Assistant** - Cortex Analyst for ad-hoc data exploration with natural language

### Key Features to Explore

- **AI-Powered Insights**: Cortex AI automatically extracts themes, analyzes sentiment, and generates business recommendations
- **Interactive Dashboards**: Filter and drill down into specific fan segments, themes, and time periods
- **Natural Language Search**: Use the Interactive Search tab to ask questions like "Show me fans with parking issues"
- **Cortex Analyst**: Ask complex questions like "What are the top pain points by month in 2024?" in the AI Assistant tab

### Dataset Information

Contains 500 synthetic basketball fan survey responses with:

- Multi-dimensional feedback across 8 categories
- Automated sentiment analysis results
- AI-generated theme classifications
- Business recommendations from Cortex COMPLETE

### Technical Notes

- All Cortex AI functions demonstrated: SENTIMENT, EXTRACT_ANSWER, COMPLETE
- Cortex Search Service configured for semantic search
- Cortex Analyst enabled for natural language SQL generation
- Sample queries and interactions available in each module

## Conclusion And Resources

### What You Learned

- How to use Cortex AI functions for sentiment analysis, automated theme extraction, and intelligent recommendation generation
- How to develop Streamlit applications on Snowflake
- How to implement DataOps deployment workflows

### Related Resources

- [Snowflake Cortex AI Functions Documentation](https://docs.snowflake.com/user-guide/snowflake-cortex/llm-functions)
- [Streamlit in Snowflake](https://docs.snowflake.com/developer-guide/streamlit/about-streamlit)
- [Cortex Search Service](https://docs.snowflake.com/user-guide/snowflake-cortex/cortex-search/cortex-search-service)
## Creating Snowflake Objects

Follow below instructions to get the FactSet Tick History data from Snowflake Marketplace.
- Navigate to [Snowsight](https://app.snowflake.com/)
- Click: Data Products
- Click: Marketplace
- Search: FactSet Tick History
- Scroll Down and Click: Tick History
- Click: Get
- Make sure the Database name is: Tick_History
- Which roles, in addition to ACCOUNTADMIN, can access this database? PUBLIC
- Click: Get

### Creating Objects, Loading Data, and Joining Data
Duration: 3

Navigate to Worksheets, click "+" in the top-right corner to create a new Worksheet, and choose "SQL Worksheet".

Paste and run the following SQL in the worksheet to create Snowflake objects (database, schema, tables),

```sql
USE ROLE ACCOUNTADMIN;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
CREATE ROLE "TESTING_SNOW_BEAR_BI" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_account_role","operation":"create"};
CREATE ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_account_role","operation":"create"};
CREATE WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" WAREHOUSE_SIZE = 'XSMALL' SCALING_POLICY = 'STANDARD' AUTO_SUSPEND = 60 AUTO_RESUME = true COMMENT = 'DATA_APP_WH warehouse for frostbyte customer experience' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"create"};
CREATE ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_account_role","operation":"create"};
CREATE ROLE "TESTING_SNOW_BEAR_DATA_APP" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_account_role","operation":"create"};
CREATE WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" WAREHOUSE_SIZE = 'XSMALL' SCALING_POLICY = 'STANDARD' AUTO_SUSPEND = 60 AUTO_RESUME = true COMMENT = 'DS_WH warehouse for frostbyte customer experience' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"create"};
CREATE WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" WAREHOUSE_SIZE = 'XSMALL' SCALING_POLICY = 'STANDARD' AUTO_SUSPEND = 60 AUTO_RESUME = true COMMENT = 'DE_WH warehouse for frostbyte customer experience' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"create"};
CREATE WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" WAREHOUSE_SIZE = 'XSMALL' SCALING_POLICY = 'STANDARD' AUTO_SUSPEND = 60 AUTO_RESUME = true COMMENT = 'DEV_WH warehouse for frostbyte customer experience' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"create"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
CREATE DATABASE "TESTING_SNOW_BEAR_PROD" COMMENT = 'This is the main DataOps database for environment PROD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_database","operation":"create"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
CREATE SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" COMMENT = 'An example schema.' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"create"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"create"};
CREATE TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" ("C_CUSTKEY" NUMBER(38,0) COMMENT '', "C_NAME" VARCHAR(25) COLLATE '' COMMENT '', "C_ADDRESS" VARCHAR(40) COLLATE '' COMMENT '', "C_NATIONKEY" NUMBER(38,0) COMMENT '', "C_PHONE" VARCHAR(15) COLLATE '' COMMENT '', "C_ACCTBAL" NUMBER(12,2) COMMENT '', "C_MKTSEGMENT" VARCHAR(10) COLLATE '' COMMENT '', "C_COMMENT" VARCHAR(117) COLLATE '' COMMENT '') DATA_RETENTION_TIME_IN_DAYS = 1 --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_table","operation":"create"};
DESCRIBE TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TYPE = COLUMNS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_table","operation":"create"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
GRANT USAGE ON WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT USAGE ON DATABASE "TESTING_SNOW_BEAR_PROD" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT USAGE ON DATABASE "TESTING_SNOW_BEAR_PROD" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT OPERATE ON WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT USAGE ON DATABASE "TESTING_SNOW_BEAR_PROD" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MODIFY ON WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT MONITOR ON WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT MODIFY ON WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT OPERATE ON WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT USAGE ON WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT USAGE ON DATABASE "TESTING_SNOW_BEAR_PROD" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT MODIFY ON WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT MONITOR ON WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT OPERATE ON WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT USAGE ON WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT MONITOR ON WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT INSERT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT UPDATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT SELECT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT SELECT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT INSERT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT SELECT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT INSERT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT INSERT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT UPDATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT UPDATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT DELETE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT UPDATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT DELETE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT DELETE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT DELETE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT TRUNCATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT TRUNCATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT TRUNCATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT SELECT ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT TRUNCATE ON TABLE "TESTING_SNOW_BEAR_PROD"."EXAMPLE_SCHEMA"."CUSTOMER" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
CREATE WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" WAREHOUSE_SIZE = 'XSMALL' SCALING_POLICY = 'STANDARD' AUTO_SUSPEND = 60 AUTO_RESUME = true COMMENT = 'STREAMLIT_WH warehouse for frostbyte customer experience' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"create"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
CREATE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" COMMENT = 'Snow Bear Basketball Fan Analytics Schema' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"create"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"create"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_BI";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
GRANT CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_APP";
GRANT ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
RECORD_DELIMITER = '
'
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ESCAPE_CHARACTER = '\'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');

-- Create stage for CSV data
CREATE STAGE IF NOT EXISTS CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
COMMENT = 'Stage for uploading basketball survey CSV data files';

-- Create the raw basketball survey table
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
ROLLBACK;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2) AS FOOD_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2) AS GAME_EXPERIENCE_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2) AS MERCHANDISE_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2) AS MERCHANDISE_PRICING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2) AS OVERALL_EVENT_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2) AS PARKING_SENTIMENT,   
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2) AS SEAT_LOCATION_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS FOOD_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string AS GAME_EXPERIENCE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_OFFERING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_PRICING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string  AS OVERALL_EVENT_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS PARKING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string AS SEAT_LOCATION_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably won't return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, couldn't see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
ROLLBACK;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2) AS FOOD_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2) AS GAME_EXPERIENCE_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2) AS MERCHANDISE_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2) AS MERCHANDISE_PRICING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2) AS OVERALL_EVENT_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2) AS PARKING_SENTIMENT,   
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2) AS SEAT_LOCATION_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS FOOD_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string AS GAME_EXPERIENCE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_OFFERING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_PRICING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string  AS OVERALL_EVENT_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS PARKING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string AS SEAT_LOCATION_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably won't return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, couldn't see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
ROLLBACK;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2) AS FOOD_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2) AS GAME_EXPERIENCE_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2) AS MERCHANDISE_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2) AS MERCHANDISE_PRICING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2) AS OVERALL_EVENT_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2) AS PARKING_SENTIMENT,   
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2) AS SEAT_LOCATION_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS FOOD_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string AS GAME_EXPERIENCE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_OFFERING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_PRICING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string  AS OVERALL_EVENT_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS PARKING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string AS SEAT_LOCATION_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably will not return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, could not see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
ROLLBACK;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2) AS FOOD_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2) AS GAME_EXPERIENCE_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2) AS MERCHANDISE_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2) AS MERCHANDISE_PRICING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2) AS OVERALL_EVENT_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2) AS PARKING_SENTIMENT,   
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2) AS SEAT_LOCATION_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS FOOD_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string AS GAME_EXPERIENCE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_OFFERING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_PRICING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string  AS OVERALL_EVENT_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS PARKING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string AS SEAT_LOCATION_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably will not return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, could not see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2) AS FOOD_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2) AS GAME_EXPERIENCE_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2) AS MERCHANDISE_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2) AS MERCHANDISE_PRICING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2) AS OVERALL_EVENT_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2) AS PARKING_SENTIMENT,   
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2) AS SEAT_LOCATION_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS FOOD_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string AS GAME_EXPERIENCE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_OFFERING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_PRICING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string  AS OVERALL_EVENT_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS PARKING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string AS SEAT_LOCATION_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably will not return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, could not see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
EXECUTE AS OWNER;
ROLLBACK;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2) AS FOOD_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2) AS GAME_EXPERIENCE_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2) AS MERCHANDISE_OFFERING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2) AS MERCHANDISE_PRICING_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2) AS OVERALL_EVENT_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2) AS PARKING_SENTIMENT,   
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2) AS SEAT_LOCATION_SENTIMENT,
    ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS FOOD_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string AS GAME_EXPERIENCE_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_OFFERING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS MERCHANDISE_PRICING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string  AS OVERALL_EVENT_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string AS PARKING_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string AS SEAT_LOCATION_SUMMARY,
    SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably will not return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, could not see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably will not return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, could not see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably will not return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, could not see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
INSERT INTO BASKETBALL_SURVEY_RAW (
    ID, FOOD_OFFERING_COMMENT, FOOD_OFFERING_SCORE, GAME_EXPERIENCE_COMMENT, GAME_EXPERIENCE_SCORE,
    MERCHANDISE_OFFERING_COMMENT, MERCHANDISE_OFFERING_SCORE, MERCHANDISE_PRICING_COMMENT, MERCHANDISE_PRICING_SCORE,
    OVERALL_EVENT_COMMENT, OVERALL_EVENT_SCORE, PARKING_COMMENT, PARKING_SCORE,
    SEAT_LOCATION_COMMENT, SEAT_LOCATION_SCORE, STADIUM_ACCESS_SCORE, STADIUM_COMMENT,
    TICKET_PRICE_COMMENT, TICKET_PRICE_SCORE, COMPANY_NAME, TOPIC
)
SELECT 
    ROW_NUMBER() OVER (ORDER BY 1) as ID,
    'The food options were ' || 
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'excellent with great variety'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good but could use more options'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'average, nothing special'
         ELSE 'disappointing and overpriced' END as FOOD_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as FOOD_OFFERING_SCORE,
    'The game experience was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'amazing, great atmosphere'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'exciting and well organized'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay but could be better'
         ELSE 'boring and poorly managed' END as GAME_EXPERIENCE_COMMENT,
    UNIFORM(1,5,RANDOM()) as GAME_EXPERIENCE_SCORE,
    'Merchandise quality was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'excellent'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'good'
         ELSE 'poor' END as MERCHANDISE_OFFERING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_OFFERING_SCORE,
    'Merchandise pricing was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'too expensive'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'reasonable'
         ELSE 'a good value' END as MERCHANDISE_PRICING_COMMENT,
    UNIFORM(1,5,RANDOM()) as MERCHANDISE_PRICING_SCORE,
    'Overall the event was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'fantastic, will definitely return'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'good, enjoyed the experience'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'okay, might come back'
         ELSE 'disappointing, probably will not return' END as OVERALL_EVENT_COMMENT,
    UNIFORM(1,5,RANDOM()) as OVERALL_EVENT_SCORE,
    'Parking was ' ||
    CASE WHEN UNIFORM(1,4,RANDOM()) = 1 THEN 'convenient and affordable'
         WHEN UNIFORM(1,4,RANDOM()) = 2 THEN 'okay but a bit far'
         WHEN UNIFORM(1,4,RANDOM()) = 3 THEN 'expensive but close'
         ELSE 'terrible, too expensive and crowded' END as PARKING_COMMENT,
    UNIFORM(1,5,RANDOM()) as PARKING_SCORE,
    'Seat location was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'perfect with great views'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'decent for the price'
         ELSE 'poor, could not see well' END as SEAT_LOCATION_COMMENT,
    UNIFORM(1,5,RANDOM()) as SEAT_LOCATION_SCORE,
    UNIFORM(1,5,RANDOM()) as STADIUM_ACCESS_SCORE,
    'Stadium access was ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'easy and well organized'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'okay with some congestion'
         ELSE 'confusing and crowded' END as STADIUM_COMMENT,
    'Ticket prices were ' ||
    CASE WHEN UNIFORM(1,3,RANDOM()) = 1 THEN 'fair for the experience'
         WHEN UNIFORM(1,3,RANDOM()) = 2 THEN 'a bit expensive'
         ELSE 'way too expensive' END as TICKET_PRICE_COMMENT,
    UNIFORM(1,5,RANDOM()) as TICKET_PRICE_SCORE,
    'Snow Bear Basketball' as COMPANY_NAME,
    'Fan Experience Survey' as TOPIC
FROM TABLE(GENERATOR(ROWCOUNT => 500));
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE ROLE ACCOUNTADMIN;
GRANT DATABASE ROLE SNOWFLAKE.CORTEX_USER TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
GRANT USAGE, OPERATE ON WAREHOUSE TESTING_SNOW_BEAR_DS_WH TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball fan experience analyst. Based on the fan feedback, classify their main concern or positive experience into ONE category: "Food & Concessions", "Game Experience", "Parking", "Seating", "Merchandise", "Pricing", "Stadium Access", "Overall Event", or "No Clear Theme". Only respond with the category name, nothing else.'
        },
        {
            'role': 'user',
            'content': CONCAT('Fan feedback: "', LEFT(AGGREGATE_COMMENT, 300), '"')
        }
    ],
    {
        'temperature': 0.1,
        'max_tokens': 20
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DE_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DEV_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DATA_APP_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
REVOKE CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE EXTERNAL TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE FILE FORMAT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE FUNCTION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE USAGE ON DATABASE "TESTING_SNOW_BEAR_PROD" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE PROCEDURE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE USAGE ON DATABASE "TESTING_SNOW_BEAR_PROD" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE USAGE ON DATABASE "TESTING_SNOW_BEAR_PROD" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE ADD SEARCH OPTIMIZATION ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE SEQUENCE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
GRANT MODIFY ON WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT OPERATE ON WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT USAGE ON WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
GRANT MONITOR ON WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" TO ROLE "TESTING_SNOW_BEAR_DATA_SCIENTIST";
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
REVOKE CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAM ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE TASK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE MODIFY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
REVOKE CREATE TABLE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE TAG ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE MONITOR ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE USAGE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
REVOKE CREATE NOTEBOOK ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE MASKING POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_ENGINEER";
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_BI";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE MATERIALIZED VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
REVOKE CREATE VIEW ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE ROW ACCESS POLICY ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
REVOKE CREATE STREAMLIT ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
REVOKE CREATE PIPE ON SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" FROM ROLE "TESTING_SNOW_BEAR_DATA_APP";
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
ROLLBACK;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
select 1;
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
select 1;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
select 1;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
select 1;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
select 1;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
USE DATABASE TESTING_SNOW_BEAR_PROD;
SELECT 1;
SELECT 1;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
SELECT CURRENT_SESSION() as CURRENT_SESSION;
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
select 1;
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
INSERT INTO TESTING_SNOW_BEAR_PROD.EXAMPLE_SCHEMA.CUSTOMER ("C_CUSTKEY","C_NAME","C_ADDRESS","C_NATIONKEY","C_PHONE","C_ACCTBAL","C_MKTSEGMENT","C_COMMENT")  VALUES  (60001,'Customer01','9Ii4zQn9cX',14,'24-678-784-9652',9957.56,'HOUSEHOLD','l theodolites boost slyly at the platelets: permanently ironic packages wake slyly pend'), (60002,'Customer02','ThGBMjDwKzkoOxhz',15,'25-782-500-8435',742.46,'BUILDING',' beans. fluffily regular packages'), (60003,'Customer03','Ed hbPtTXMTAsgGhCr4HuTzK,Md2',16,'26-859-847-7640',2526.92,'BUILDING','fully pending deposits sleep quickly. blithely unusual accounts across the blithely bold requests are quickly'), (60004,'Customer04','NivCT2RVaavl,yUnKwBjDyMvB42WayXCnky',10,'20-573-674-7999',7975.22,'AUTOMOBILE',' furiously above the ironic packages. slyly brave ideas boost. final platelets detect according to the ironi'), (60005,'Customer05','1F3KM3ccEXEtI, B22XmCMOWJMl',12,'22-741-208-1316',2504.74,'MACHINERY','express instructions sleep quickly. ironic braids cajole furiously fluffily p'), (60006,'Customer06','3isiXW651fa8p ',22,'32-618-195-8029',9051.4,'MACHINERY',' carefully quickly even theodolites. boldly '), (60007,'Customer07','sp6KJmx,TiSWbMPvhkQwFwTuhSi4a5OLNImpcGI',12,'22-491-919-9470',6017.17,'FURNITURE','bold packages. regular sheaves mold. blit'), (60008,'Customer08','3VteHZYOfbgQioA96tUeL0R7i',2,'12-693-562-7122',5621.44,'AUTOMOBILE','nal courts. carefully regular Tiresias lose quickly unusual packages. regular, bold i'), (60009,'Customer09','S60sNpR6wnacPBLeOxjxhvehf',9,'19-578-776-2699',9548.01,'FURNITURE','efully even dependencies haggle furiously along the express packages. final requests boost'), (60010,'Customer10','c4vEEaV1tdqLdw2oVuXp BN',21,'31-677-809-6961',3497.91,'HOUSEHOLD','fter the quickly silent requests. slyly special theodolites along the even, even requests boos');
COMMIT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
select 1;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SUSPEND --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" RESUME IF SUSPENDED --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
select 1;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" SET WAREHOUSE_TYPE = 'STANDARD' --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_STREAMLIT_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
ALTER WAREHOUSE "TESTING_SNOW_BEAR_DS_WH" UNSET MAX_CLUSTER_COUNT, MIN_CLUSTER_COUNT, ENABLE_QUERY_ACCELERATION, QUERY_ACCELERATION_MAX_SCALE_FACTOR --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_warehouse","operation":"update"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"read"};
SELECT 1;
SELECT 1;
SELECT CURRENT_SESSION() as CURRENT_SESSION;
ALTER SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" DISABLE MANAGED ACCESS --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
DESCRIBE SCHEMA "TESTING_SNOW_BEAR_PROD"."ANALYTICS" --terraform_provider_usage_tracking {"json_schema_version":"1","version":"v1.0.4","resource":"snowflake_schema","operation":"update"};
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_STREAMLIT_WH;
USE ROLE ACCOUNTADMIN;
USE ROLE ACCOUNTADMIN;
CREATE OR REPLACE STREAMLIT TESTING_SNOW_BEAR_PROD.ANALYTICS.TESTING_SNOW_BEAR_SNOWBEAR_FAN_360
ROOT_LOCATION = '@TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_FAN_360'
MAIN_FILE = 'snowbear_fan_360.py'
QUERY_WAREHOUSE = 'TESTING_SNOW_BEAR_STREAMLIT_WH'
COMMENT = '{"origin":"sf_sit-is", "name":"snowbear_fan_360", "version":{"major":1, "minor":0}, "attributes":{"is_quickstart":0, "source":"streamlit"}}';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE FILE FORMAT CSV_FORMAT
TYPE = 'CSV'
FIELD_DELIMITER = ','
SKIP_HEADER = 1
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
ENCODING = 'UTF8'
NULL_IF = ('NULL', 'null', '');
CREATE OR REPLACE TABLE BASKETBALL_SURVEY_RAW (
    ID VARCHAR(16777216),
    FOOD_OFFERING_COMMENT VARCHAR(16777216),
    FOOD_OFFERING_SCORE VARCHAR(16777216),
    GAME_EXPERIENCE_COMMENT VARCHAR(16777216),
    GAME_EXPERIENCE_SCORE VARCHAR(16777216),
    MERCHANDISE_OFFERING_COMMENT VARCHAR(16777216),
    MERCHANDISE_OFFERING_SCORE VARCHAR(16777216),
    MERCHANDISE_PRICING_COMMENT VARCHAR(16777216),
    MERCHANDISE_PRICING_SCORE VARCHAR(16777216),
    OVERALL_EVENT_COMMENT VARCHAR(16777216),
    OVERALL_EVENT_SCORE VARCHAR(16777216),
    PARKING_COMMENT VARCHAR(16777216),
    PARKING_SCORE VARCHAR(16777216),
    SEAT_LOCATION_COMMENT VARCHAR(16777216),
    SEAT_LOCATION_SCORE VARCHAR(16777216),
    STADIUM_ACCESS_SCORE VARCHAR(16777216),
    STADIUM_COMMENT VARCHAR(16777216),
    TICKET_PRICE_COMMENT VARCHAR(16777216),
    TICKET_PRICE_SCORE VARCHAR(16777216),
    COMPANY_NAME VARCHAR(16777216),
    TOPIC VARCHAR(16777216),
    CREATED_TIMESTAMP TIMESTAMP_NTZ(9) DEFAULT CURRENT_TIMESTAMP()
);
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
COPY INTO BASKETBALL_SURVEY_RAW
FROM @CSV_DATA_STAGE
FILE_FORMAT = CSV_FORMAT
ON_ERROR = 'CONTINUE';
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TABLE QUALTRICS_SCORECARD AS
SELECT 
    DATEADD(DAY, UNIFORM(1, 365, RANDOM()), '2024-06-01') AS REVIEW_DATE,
    A.*,
    CAST(NULL AS INTEGER) as AGGREGATE_SCORE,       
    FOOD_OFFERING_COMMENT||' '||
    GAME_EXPERIENCE_COMMENT||' '||
    MERCHANDISE_OFFERING_COMMENT||' '||
    MERCHANDISE_PRICING_COMMENT||' '||
    OVERALL_EVENT_COMMENT||' '||
    PARKING_COMMENT||' '||
    SEAT_LOCATION_COMMENT   
    AS AGGREGATE_COMMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS ALT_AGGREGATE_SENTIMENT,
    CAST(NULL AS FLOAT) AS AGGREGATE_SENTIMENT_SPREAD,
    CAST(NULL AS FLOAT) AS FOOD_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS GAME_EXPERIENCE_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_OFFERING_SENTIMENT,
    CAST(NULL AS FLOAT) AS MERCHANDISE_PRICING_SENTIMENT,
    CAST(NULL AS FLOAT) AS OVERALL_EVENT_SENTIMENT,
    CAST(NULL AS FLOAT) AS PARKING_SENTIMENT,   
    CAST(NULL AS FLOAT) AS SEAT_LOCATION_SENTIMENT,
    CAST(NULL AS FLOAT) AS STADIUM_ACCESS_SENTIMENT,
    CAST(NULL AS VARCHAR(1000)) AS AGGREGATE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS FOOD_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS GAME_EXPERIENCE_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_OFFERING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MERCHANDISE_PRICING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS OVERALL_EVENT_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS PARKING_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS SEAT_LOCATION_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS STADIUM_ACCESS_SUMMARY,
    CAST(NULL AS VARCHAR(1000)) AS MAIN_THEME,
    CAST(NULL AS VARCHAR(1000)) AS SECONDARY_THEME,
    CAST(0 AS INTEGER) AS FOOD,
    CAST(0 AS INTEGER) AS PARKING,
    CAST(0 AS INTEGER) AS SEATING,    
    CAST(0 AS INTEGER) AS MERCHANDISE,      
    CAST(0 AS INTEGER) AS GAME,
    CAST(0 AS INTEGER) AS TICKET,
    CAST(0 AS INTEGER) AS NO_THEME,
    CAST(0 AS INTEGER) AS VIP,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT,
    CAST(NULL as VARCHAR(1000)) AS SEGMENT_ALT,
    CAST(NULL AS VARCHAR(8000)) AS BUSINESS_RECOMMENDATION,       
    CAST(NULL AS VARCHAR(8000)) AS COMPLEX_RECOMMENDATION
FROM BASKETBALL_SURVEY_RAW A;
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(FOOD_OFFERING_COMMENT), 2),
    GAME_EXPERIENCE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(GAME_EXPERIENCE_COMMENT), 2),
    MERCHANDISE_OFFERING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_OFFERING_COMMENT), 2),
    MERCHANDISE_PRICING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(MERCHANDISE_PRICING_COMMENT), 2),
    OVERALL_EVENT_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(OVERALL_EVENT_COMMENT), 2),
    PARKING_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(PARKING_COMMENT), 2),
    SEAT_LOCATION_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(SEAT_LOCATION_COMMENT), 2),
    STADIUM_ACCESS_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(STADIUM_COMMENT), 2);
UPDATE QUALTRICS_SCORECARD
SET 
    FOOD_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(FOOD_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    GAME_EXPERIENCE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(GAME_EXPERIENCE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_OFFERING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_OFFERING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    MERCHANDISE_PRICING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(MERCHANDISE_PRICING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    OVERALL_EVENT_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(OVERALL_EVENT_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    PARKING_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(PARKING_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    SEAT_LOCATION_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(SEAT_LOCATION_COMMENT,'ASSIGN A THEME')[0]:answer::string,
    STADIUM_ACCESS_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(STADIUM_COMMENT,'ASSIGN A THEME')[0]:answer::string;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SCORE = TRUNC((CASE WHEN FOOD_OFFERING_SCORE = 'N/A' THEN NULL ELSE FOOD_OFFERING_SCORE END+
                                CASE WHEN GAME_EXPERIENCE_SCORE = 'N/A' THEN NULL ELSE GAME_EXPERIENCE_SCORE END+
                                CASE WHEN MERCHANDISE_OFFERING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_OFFERING_SCORE END +
                          CASE WHEN MERCHANDISE_PRICING_SCORE = 'N/A' THEN NULL ELSE MERCHANDISE_PRICING_SCORE END +
                          CASE WHEN OVERALL_EVENT_SCORE = 'N/A' THEN NULL ELSE OVERALL_EVENT_SCORE END +
                          CASE WHEN PARKING_SCORE = 'N/A' THEN NULL ELSE PARKING_SCORE END +
                          CASE WHEN SEAT_LOCATION_SCORE = 'N/A' THEN NULL ELSE SEAT_LOCATION_SCORE END +
                          CASE WHEN STADIUM_ACCESS_SCORE = 'N/A' THEN NULL ELSE STADIUM_ACCESS_SCORE END)/8),
       AGGREGATE_SENTIMENT = ROUND(SNOWFLAKE.CORTEX.SENTIMENT(AGGREGATE_COMMENT), 2),
       AGGREGATE_SUMMARY = SNOWFLAKE.CORTEX.EXTRACT_ANSWER(AGGREGATE_COMMENT,'ASSIGN A THEME')[0]:answer::string,
       ALT_AGGREGATE_SENTIMENT = (FOOD_OFFERING_SENTIMENT+GAME_EXPERIENCE_SENTIMENT+MERCHANDISE_OFFERING_SENTIMENT+
                                 MERCHANDISE_PRICING_SENTIMENT+OVERALL_EVENT_SENTIMENT+PARKING_SENTIMENT+
                                 SEAT_LOCATION_SENTIMENT+STADIUM_ACCESS_SENTIMENT)/8;
UPDATE QUALTRICS_SCORECARD
   SET AGGREGATE_SENTIMENT_SPREAD = ALT_AGGREGATE_SENTIMENT - AGGREGATE_SENTIMENT;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE TRANSIENT TABLE EXTRACTED_THEMES_SNOWBEAR AS
WITH all_feedback AS (
    SELECT 
        LEFT(LISTAGG(
            CONCAT(
                'FOOD: ', COALESCE(LEFT(FOOD_OFFERING_COMMENT,200), ''), ' | ',
                'GAME: ', COALESCE(LEFT(GAME_EXPERIENCE_COMMENT,200), ''), ' | ',
                'MERCH_OFFERING: ', COALESCE(LEFT(MERCHANDISE_OFFERING_COMMENT,200), ''), ' | ',
                'MERCH_PRICING: ', COALESCE(MERCHANDISE_PRICING_COMMENT, ''), ' | ',
                'PARKING: ', COALESCE(LEFT(PARKING_COMMENT,200), ''), ' | ',
                'SEATS: ', COALESCE(LEFT(SEAT_LOCATION_COMMENT,200), ''), ' | ',
                'STADIUM_ACCESS: ', COALESCE(LEFT(STADIUM_COMMENT,200), ''),  ' | ',
                'OVERALL: ', COALESCE(LEFT(OVERALL_EVENT_COMMENT,200), ''), ''
            ), 
            ' || '
        ) WITHIN GROUP (ORDER BY ID), 50000) as all_feedback_text
    FROM QUALTRICS_SCORECARD
)
SELECT 
    CURRENT_TIMESTAMP() as analysis_date,
    (SELECT COUNT(*) FROM QUALTRICS_SCORECARD) as total_responses,
    SNOWFLAKE.CORTEX.COMPLETE(
        'llama3.1-8b',
        [
            {
                'role': 'system',
                'content': 'You are a marketing analyst for a Major League Basketball team. Analyze all fan feedback and identify the top 20 recurring themes. Focus on actionable insights that can improve fan experience. Return ONLY a numbered list 1-20 with concise theme descriptions. Format should be returned as a JSON array with objects containing theme_number, theme_name, and theme_description. Return only valid JSON array, no other text'
            },
            {
                'role': 'user',
                'content': CONCAT('Analyze this Major League Basketball fan feedback and extract the top 20 themes: ', all_feedback_text)
            }
        ],
        {
            'temperature': 0.2,
            'max_tokens': 4096
        }
    ):choices[0]:messages::string as top_20_themes
FROM all_feedback;
CREATE OR REPLACE TABLE EXTRACTED_THEMES_STRUCTURED AS
WITH theme_text AS (
    SELECT TOP_20_THEMES as theme_analysis_text
    FROM EXTRACTED_THEMES_SNOWBEAR
),
parsed_themes AS (
    SELECT 
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'Convert this theme analysis into a JSON array with objects containing theme_number, theme_name, and theme_description. Return ONLY valid JSON array, no other text.'
                },
                {
                    'role': 'user',
                    'content': CONCAT('Convert this to JSON format: ', theme_analysis_text)
                }
            ],
            {
                'temperature': 0.1,
                'max_tokens': 2000
            }
        ):choices[0]:messages::string as themes_json
    FROM theme_text
)
SELECT 
    TRY_CAST(theme.value:theme_number::string AS INTEGER) as THEME_NUMBER,
    theme.value:theme_name::string as THEME_NAME,
    theme.value:theme_description::string as THEME_DESCRIPTION,
    CURRENT_TIMESTAMP() as CREATED_DATE
FROM parsed_themes,
LATERAL FLATTEN(input => TRY_PARSE_JSON(REPLACE(themes_json,'```',''))) as theme
WHERE theme.value:theme_number IS NOT NULL
ORDER BY THEME_NUMBER;
CREATE OR REPLACE TRANSIENT TABLE SCORECARD_THEME_INFO_SNOWBEAR
AS
WITH theme_list AS (
    SELECT LISTAGG(THEME_NAME, '", "') WITHIN GROUP (ORDER BY THEME_NUMBER) AS THEME_LIST
    FROM EXTRACTED_THEMES_STRUCTURED
),
classified_themes AS (
    SELECT 
        ID,
        SNOWFLAKE.CORTEX.COMPLETE(
            'llama3.1-8b',
            [
                {
                    'role': 'system',
                    'content': 'You are a customer experience analyst. Based on fan feedback, sentiment, and scores, identify the top 2 most relevant themes. Examples of themes are Parking, Food, Security, Seating.  Consider both content and sentiment intensity. Return ONLY the two themes seperated by |. Here are good exmples of ideal formatting of results "Parking | Concessions" or "Game Experience | Security". If there is only one theme you can identify return a single theme E.g., Food or Ticket Prices.  If there is insuffient info or no clear classification return "No Clear Theme" Do not add any new words or come up with analysis verbage or create new themes only use the ones you are given'
                },
                {
                    'role': 'user',
                    'content': CONCAT(
                        'Available themes: "', (SELECT THEME_LIST FROM theme_list), '". ',
                        'Fan feedback: "', REPLACE(AGGREGATE_COMMENT, '''', ''), '". ',
                        'Overall sentiment: ', AGGREGATE_SENTIMENT, ' (range: -1 to +1). ',
                        'Aggregate score: ', AGGREGATE_SCORE, '/5. ',
                        'Food sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                        'Game sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                        'Parking sentiment: ', PARKING_SENTIMENT, ', ',
                        'Merchandise sentiment: ', MERCHANDISE_PRICING_SENTIMENT
                    )
                }
            ],
            {
                'temperature': 0.2,
                'max_tokens': 100
            }
        ):choices[0]:messages::string as theme_classification
    FROM QUALTRICS_SCORECARD
    WHERE AGGREGATE_COMMENT IS NOT NULL
)
SELECT case when ct.theme_classification like 'Based on %' then 'No Clear Theme' else ct.theme_classification end as theme_classification,
       ct.id
FROM classified_themes ct;
UPDATE QUALTRICS_SCORECARD
SET 
    MAIN_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, 1, CHARINDEX('|', ct.theme_classification) - 1))
        ELSE TRIM(ct.theme_classification)
    END,
    SECONDARY_THEME = CASE 
        WHEN CHARINDEX('|', ct.theme_classification) > 0 
        THEN TRIM(SUBSTRING(ct.theme_classification, CHARINDEX('|', ct.theme_classification) + 1, LEN(ct.theme_classification)))
        ELSE NULL
    END,
    FOOD = case when charindex('FOOD',upper(ct.theme_classification))> 0 then 1 else 0 end,
    PARKING = case when charindex('PARKING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    SEATING = case when charindex('SEATING',upper(ct.theme_classification))> 0 then 1 else 0 end,
    VIP = case when charindex('VIP',upper(ct.theme_classification))> 0 then 1 else 0 end,
    NO_THEME = case when charindex('CLEAR THEME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    GAME = case when charindex('GAME',upper(ct.theme_classification))> 0 then 1 else 0 end,
    TICKET = case when charindex('TICKET',upper(ct.theme_classification))> 0 then 1 else 0 end,   
    MERCHANDISE = case when charindex('MERCHANDISE',upper(ct.theme_classification))> 0 then 1 else 0 end
FROM SCORECARD_THEME_INFO_SNOWBEAR ct
WHERE QUALTRICS_SCORECARD.ID = ct.ID;
UPDATE QUALTRICS_SCORECARD
SET MAIN_THEME = CASE 
    WHEN UPPER(MAIN_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(MAIN_THEME) LIKE '%PARIKNG%' OR UPPER(MAIN_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(MAIN_THEME) LIKE '%PARKIN%FEE%' OR UPPER(MAIN_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(MAIN_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(MAIN_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(MAIN_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(MAIN_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(MAIN_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE MAIN_THEME
END,
SECONDARY_THEME = CASE 
    WHEN UPPER(SECONDARY_THEME) LIKE '%FOOD%QUALIT%' THEN 'Food Quality'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARIKNG%' OR UPPER(SECONDARY_THEME) LIKE '%PARKIN%' THEN 'Parking'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PARKIN%FEE%' OR UPPER(SECONDARY_THEME) LIKE '%PARIKNG%FEE%' THEN 'Parking Fees'
    WHEN UPPER(SECONDARY_THEME) LIKE '%MERCHAND%' THEN 'Merchandise'
    WHEN UPPER(SECONDARY_THEME) LIKE '%EXPERIEN%' THEN 'Experience'
    WHEN UPPER(SECONDARY_THEME) LIKE '%CONCESSION%' THEN 'Concessions'
    WHEN UPPER(SECONDARY_THEME) LIKE '%SEATIN%' THEN 'Seating'
    WHEN UPPER(SECONDARY_THEME) LIKE '%PRICIN%' THEN 'Pricing'
    ELSE SECONDARY_THEME
END
WHERE MAIN_THEME IS NOT NULL OR SECONDARY_THEME IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a customer segmentation expert. Based on fan feedback, scores, and sentiment, classify each fan into ONE of these segments: "Premium Experience Seeker", "Value-Conscious Fan", "Loyal Supporter", "Experience Critic", "Family-Focused Fan", "Convenience-Driven Fan", or "Occasional Attendee". Only provide the segment name, no explanation.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Overall Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ' (-1 to +1), ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 50
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET SEGMENT_ALT = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'Segment this fan based on satisfaction level, price sensitivity, and experience priorities. Return the result as just the segment name you came up with. So if the segment name is E.g., High-Value Critic the response should be only High-Value Critic. Here are some ideas of Segment Names(e.g., "High-Value Critic", "Budget-Conscious Loyalist", "Premium Experience Seeker", "Family-First Fan", "Convenience-Focused Casual", "Dissatisfied Price-Sensitive", "Happy Regular"). Do not provide any analysis and explanation only provide the actual segment name do not put any prefix like Here is the ... '
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Analysis: ',
                'Satisfaction Level: ', 
                CASE 
                    WHEN AGGREGATE_SCORE >= 4 THEN 'High'
                    WHEN AGGREGATE_SCORE >= 3 THEN 'Medium' 
                    ELSE 'Low'
                END, ', ',
                'Price Sensitivity: ',
                CASE 
                    WHEN MERCHANDISE_PRICING_SENTIMENT < -0.3 THEN 'High'
                    WHEN MERCHANDISE_PRICING_SENTIMENT < 0.3 THEN 'Medium'
                    ELSE 'Low'
                END, ', ',
                'Parking Issues: ',
                CASE 
                    WHEN PARKING_SENTIMENT < -0.3 THEN 'Major Concern'
                    WHEN PARKING_SENTIMENT < 0.3 THEN 'Minor Concern'
                    ELSE 'No Issues'
                END, ', ',
                'Food Experience: ',
                CASE 
                    WHEN FOOD_OFFERING_SENTIMENT >= 0.3 THEN 'Positive'
                    WHEN FOOD_OFFERING_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Game Experience: ',
                CASE 
                    WHEN GAME_EXPERIENCE_SENTIMENT >= 0.3 THEN 'Highly Positive'
                    WHEN GAME_EXPERIENCE_SENTIMENT >= -0.3 THEN 'Neutral'
                    ELSE 'Negative'
                END, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 100), '"'
            )
        }
    ],
    {
        'temperature': 0.2,
        'max_tokens': 30
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET BUSINESS_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are a basketball team revenue optimization specialist. Generate specific, actionable recommendations that improve fan satisfaction AND drive business value (ticket sales, concessions, merchandise, retention). Be concise and specific.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Fan Profile: Segment: ', SEGMENT, ', Score: ', AGGREGATE_SCORE, '/5, ',
                'Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Key Feedback: "', LEFT(AGGREGATE_COMMENT, 150), '"'
            )
        }
    ],
    {
        'temperature': 0.3,
        'max_tokens': 200
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL;
UPDATE QUALTRICS_SCORECARD
SET COMPLEX_RECOMMENDATION = SNOWFLAKE.CORTEX.COMPLETE(
    'llama3.1-8b',
    [
        {
            'role': 'system',
            'content': 'You are an advanced customer experience strategist for a professional basketball team. Based on comprehensive fan data including themes, segments, and detailed feedback, provide sophisticated, multi-dimensional recommendations that address both immediate concerns and long-term fan engagement strategies. Consider operational improvements, technological enhancements, and personalized experience design.'
        },
        {
            'role': 'user',
            'content': CONCAT(
                'Comprehensive Fan Profile: ',
                'Primary Segment: ', SEGMENT, ', ',
                'Alternative Segment: ', SEGMENT_ALT, ', ',
                'Satisfaction Score: ', AGGREGATE_SCORE, '/5, ',
                'Overall Sentiment: ', AGGREGATE_SENTIMENT, ', ',
                'Main Theme: ', MAIN_THEME, ', ',
                'Secondary Theme: ', SECONDARY_THEME, ', ',
                'Food Sentiment: ', FOOD_OFFERING_SENTIMENT, ', ',
                'Game Sentiment: ', GAME_EXPERIENCE_SENTIMENT, ', ',
                'Parking Sentiment: ', PARKING_SENTIMENT, ', ',
                'Detailed Feedback: "', LEFT(AGGREGATE_COMMENT, 200), '"'
            )
        }
    ],
    {
        'temperature': 0.4,
        'max_tokens': 300
    }
):choices[0]:messages::string
WHERE AGGREGATE_COMMENT IS NOT NULL AND SEGMENT IS NOT NULL AND SEGMENT_ALT IS NOT NULL;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
REMOVE @SEMANTIC_MODELS;
USE DATABASE TESTING_SNOW_BEAR_PROD;
USE WAREHOUSE TESTING_SNOW_BEAR_DS_WH;
USE ROLE ACCOUNTADMIN;
USE SCHEMA TESTING_SNOW_BEAR_PROD.ANALYTICS;
CREATE OR REPLACE CORTEX SEARCH SERVICE SNOWBEAR_SEARCH_ANALYSIS
  ON AGGREGATE_COMMENT
  ATTRIBUTES AGGREGATE_SCORE,SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
  WAREHOUSE = TESTING_SNOW_BEAR_DS_WH
  TARGET_LAG = '1 days'
  EMBEDDING_MODEL = 'snowflake-arctic-embed-m-v1.5'
  INITIALIZE = ON_CREATE 
  COMMENT = 'CORTEX SEARCH SERVICE TO SUPPORT SNOW BEAR FAN EXPERIENCE ANALYSIS' 
  AS (
    SELECT
		AGGREGATE_COMMENT,AGGREGATE_SCORE,
        SEGMENT, SEGMENT_ALT, MAIN_THEME, SECONDARY_THEME,
        PARKING_SCORE,SEAT_LOCATION_SCORE,
        OVERALL_EVENT_SCORE,MERCHANDISE_PRICING_SCORE,
        MERCHANDISE_OFFERING_SCORE,GAME_EXPERIENCE_SCORE,
        FOOD_OFFERING_SCORE,REVIEW_DATE,ID
	FROM QUALTRICS_SCORECARD
  );
GRANT USAGE ON CORTEX SEARCH SERVICE TESTING_SNOW_BEAR_PROD.ANALYTICS.SNOWBEAR_SEARCH_ANALYSIS TO ROLE TESTING_SNOW_BEAR_DATA_SCIENTIST;
select 1;
select 1;
USE ROLE accountadmin;
CREATE SCHEMA IF NOT EXISTS ANALYTICS;
CREATE or replace STAGE TESTING_SNOW_BEAR_PROD.ANALYTICS.QUICKSTART 
DIRECTORY = (ENABLE = TRUE) 
ENCRYPTION = (TYPE = '‚ò∫‚ò∫‚ò∫‚ò∫‚ò∫');
use role ACCOUNTADMIN;
use DATABASE TESTING_SNOW_BEAR_PROD;
use schema ANALYTICS;


```
```
